<style>
.video-container {
position: relative;
padding-bottom: 56.25%;
padding-top: 30px;
height: 0;
overflow: hidden;
}

.video-container iframe, .video-container object, .video-container embed {
position: absolute;
top: 0;left: 0;
width: 100%;
height: 100%;
}

.gm-style img {
    max-width: none!important;
}

.addrInput .addr {
width: 80%;
}

textarea.ta {
width: 98%;
}

/* css-table div */
.css-table .tr {
 display: flex;
}

.css-table .td {
  display: table;
}

.css-table .hw {
  width: 108px;
}

/* info box */
.infoa {
    border: 8px solid transparent;
    border-left: 0px;
    cursor: help;
  }

  .info {
    border: 1px solid black;
    position: absolute;
    color: deepskyblue;
    background: black;
    width: 80px;
  }

</style>
<div class="main">
<div class="video-container" id="map0" ></div>
<div class="addrInput">
<input class="addr" id="geocodeInput" type="text" value="台北縣永和市保平路" />
<input id="" onclick="geocodePOS()" type="button" value="定位" />
</div>
<div class="markerManage">
  <label>點位管理</label>
  <input id="markerPOS" onkeyup="openMarkerInfoByPOS()" size="4" />
  <input id="markerNum" size="4" />
  <input id="" onclick="markersGControl('prev')" type="button" value="前" />
  <input id="" onclick="markersGControl('next')" type="button" value="後" />
  <input id="" onclick="markersGControl('del')" type="button" value="消" />
  <input onclick="clearAlloverlays()" type="button" value="全消" />
</div>
<div class="clickOption">
  <label>點擊功能</label> 
  <input id="geocodeCHK" type="checkbox" />查地址
  <input checked="" id="area10m" type="checkbox" />10m
  <input checked="" id="area100m" type="checkbox" />100m
  <input id="area800x500m" type="checkbox" />800x500m  
</div>
<hr />

<form name="set0">
<label>輸入區: 主要支援 逗號(,)分隔 的資料格式，TAB(\t)會轉成逗號</label>
<textarea class="ta" cols="60" name="inputData" rows="5"></textarea>
<label>訊息欄:</label>
<textarea class="ta" cols="60" id="settingView" name="settingView" rows="5"></textarea>
<div>
<input onclick="getInputDataAll()" type="button" value="取得輸入資料" />
<input onclick="calcInputDataAll()" type="button" value="BW七參數" />
<a class="infoa" onclick="infoDiv(this)">i<div class="info" style="display:none">此轉換取用下表參數</div></a>
</div>
<div>
<input onclick="calcDataByNCKU(1)" type="button" value="成大67轉97" />
<input onclick="calcDataByNCKU(2)" type="button" value="成大97轉67" />
<input onclick="baseConvert()" type="button" value="基石轉換" />
<a class="infoa" onclick="infoDiv(this)">i<div class="info" style="display:none">僅限台灣地區</div></a>
</div>
<div>
<input onclick="llGMap(1)" type="button" value="LL1->GMap" />
<input onclick="llGMap(2)" type="button" value="LL2->GMap" />
</div>
<div>
<div>
輸出項目
</div>
<div>
<input id="LLh1" name="outSet" type="checkbox" />LLh1
<input id="tmXY1" name="outSet" type="checkbox" />tmXY1
</div>
<div>
<input id="XYZ1" name="outSet" type="checkbox" />XYZ1
<input id="XYZ0" name="outSet" type="checkbox" />XYZ0
<input id="XYZ2" name="outSet" type="checkbox" />XYZ2
</div>
<div>
<input checked="" id="LLh2" name="outSet" type="checkbox" />LLh2
<input checked="" id="tmXY2" name="outSet" type="checkbox" />tmXY2
</div>
<div>
<input id="TPName1" name="outSet" type="checkbox" />TPName1
<input id="TPName2" name="outSet" type="checkbox" />TPName2
</div>
<div>
<div>
<input id="AddressCHK" name="outSet" onclick="convAddressAlert()" type="checkbox" />轉地址
<input id="Address1" name="addressSlt" type="radio" />地址1
<input id="Address2" name="addressSlt" type="radio" />地址2
</div>
</div>
</div>
<div>
	<div>
電力座標表:
<select id="quickTPsetSlt" onchange="callTPsetSlt()">
<option selected value="TPset1">台灣:中央經線:121</option>
<option value="TPset2">澎湖:中央經線:119</option>
</select>
<input id="chkTPset" onclick="callTPSet(0)" type="button" value="查看" />
<input disabled="" id="CngTPSet" onclick="changeTPSet()" type="button" value="變更" />
	</div>
<div>
xy軸顯示設定<input id="xyset" onclick="disableCngTPSet()" type="checkbox" />
<input id="TPSet2GMAP" onclick="getTPset2GMap()" type="button" value="分區GMap!" />
</div>
</div>
<hr />
快速設定:
<select id="quickSetSlt" onchange="callQuickSet()">
<option selected="" value="none">------------------------------------------
</option><option value="set67to84">台灣67轉84: TWD67-TM2-121-to-WGS84-TM6-123
</option><option value="set67to97">台灣67轉97: TWD67-TM2-121-to-TWD97-TM2-121
</option><option value="set84to67">台灣84轉67: WGS84-TM6-123-to-TWD67-TM2-121
</option><option value="set97to67">台灣97轉67: TWD97-TM2-121-to-TWD67-TM2-121
</option><option value="set67to84PH">澎湖: TWD67-TM2-119-to-WGS84-TM6-117
</option><option value="set67to97PH">澎湖: TWD67-TM2-119-to-TWD97-TM2-119
</option><option value="set84to67PH">澎湖: WGS84-TM6-117-to-TWD67-TM2-119
</option><option value="set97to67PH">澎湖: TWD97-TM2-119-to-TWD67-TM2-119

</option></select><br />
</form>
<form name="set1">
<b>Source Datum:</b>
<select id="DatumSet1slt" name="whatDatumSet" onchange="getSltDatumData(1)">
<option value="DatumName,a(m),1/f,b(m),dX(m),dY(m),dZ(m),Rx(asec),Ry(asec),Rz(asec),sf(ppm)">---</option>
<option id="TWD97.1" value="TWD97,6378137,298.257222101,6356752.3141,0,0,0,0,0,0,0">TWD97</option>
<option id="TWD67.1" selected="" value="TWD67,6378160,298.25,6356774.7192,-730.16,-346.212,-472.186,-7.968,-3.5498,-0.4063,-18.2">TWD67
</option>
<option id="WGS84.1" value="WGS84,6378137,298.257223563,6356752.31425,0,0,0,0,0,0,0">WGS84
</option>
</select>
<br />
DmName: <input id="DatumName.1" name="DatumSetData" value="DatumName" />
<input onclick="addDatumOption(1)" type="button" value="add Datum" />
<input onclick="chkInputDatumData(1)" type="button" value="chkDtm1" />
<div class="css-table">
  <div class="tr">
    <div class="td">
      <div>a</div>
      <div><input id="sma.1" name="DatumSetData" value="a" /></div>
    </div>
    <div class="td">
      <div>1/f</div>
      <div><input id="divf.1" name="DatumSetData" value="1/f" /></div>
    </div>
    <div class="td">
      <div>b</div>
      <div><input id="smb.1" name="DatumSetData" value="b" /></div>
    </div>
  </div>
  <div class="tr">
    <div class="td">
      <div>dX</div>
      <div><input id="dX.1" name="DatumSetData" value="dX" /></div>
    </div>
    <div class="td">
      <div>dY</div>
      <div><input id="dY.1" name="DatumSetData" value="dY" /></div>
    </div>
    <div class="td">
      <div>dZ</div>
      <div><input id="dZ.1" name="DatumSetData" value="dZ" /></div>
    </div>
  </div>
  <div class="tr">
    <div style="display:none" id="Ru1">
      <input value="asec"/>
      <a>asec</a><a>rad</a>
    </div>
    <div class="td">
      <div>Rx<b class="Ru1" onclick="asec_rad('Ru1')">(<a>asec</a>)</b></div>
      <div><input class= "Ru1v" id="Rx.1" name="DatumSetData" value="Rx" /></div>
    </div>
    <div class="td">
      <div>Ry<b class="Ru1" onclick="asec_rad('Ru1')">(<a>asec</a>)</b></div>
      <div><input class= "Ru1v" id="Ry.1" name="DatumSetData" value="Ry" /></div>
      <div></div>
    </div>
    <div class="td">
      <div>Rz<b class="Ru1" onclick="asec_rad('Ru1')">(<a>asec</a>)</b></div>
      <div><input class="Ru1v" id="Rz.1" name="DatumSetData" value="Rz" /></div>
    </div>
  </div>
  <div class="tr">
    <input style="display: none;" id="sfu1" value="ppm"/>
    <div class="td">
      <div>Scale Factor<b class="sfu1" onclick="sf_s('sfu1')">(<a>ppm</a><a style="display:none">unitless</a>)</b></div>
    <div><input class="sfu1v" id="sfppm.1" name="DatumSetData" value="sf" /></div>
  </div>
  </div>
</div>
<div class="css-table">
  <b>Source TM setting :</b> 
<select id="TMset1slt" name="whatTMset" onchange="getSltTMdata(1)">
<option value="TMdeg,Lng0(deg),Lat0(deg),k0,FE(m),FN(m)">---</option>
<option id="TM2.1" selected="" value="TM2-121,121,0,0.9999,250000,0">TM2-121</option>
<option id="TM3.1" value="TM3-121,121,0,1,350000,0">TM3-121</option>
<option id="TM6.1" value="TM6-123,123,0,0.9996,500000,0">TM6-123</option>
<option id="TM2.1.119" value="TM2-119,119,0,0.9999,250000,0">澎湖TM2-119</option>
<option id="TM6.1.117" value="TM6-117,117,0,0.9996,500000,0">澎湖TM6-117</option>
</select>
<br />
TMset: <input id="TMdeg.1" name="tmSetData" value="TMdeg" />
<input onclick="addTMOption(1)" type="button" value="add TM" /><br />
<div class="tr">
  <div class="hw">Central meridian</div>
    <div><input id="Lng0.1" name="tmSetData" value="Lng0" /></div>  
</div>
<div class="tr">
  <div class="hw">Central parallel</div>
  <div><input id="Lat0.1" name="tmSetData" value="Lat0" /></div>  
</div>
<div class="tr">
  <div class="hw">scale factor</div>
  <div><input id="k0.1" name="tmSetData" value="k0" /></div>  
</div>
<div class="tr">
  <div class="hw">False Easting</div>
  <div><input id="FE.1" name="tmSetData" value="FE" /></div>
</div>
<div class="tr">
    <div class="hw">False Northing</div>
    <div><input id="FN.1" name="tmSetData" value="FN" /></div>
</div>
</div>
<hr />
</form>
<form name="set2">
<b>Target Datum :</b>
<select id="DatumSet2slt" name="whatDatumSet" onchange="getSltDatumData(2)">
<option value="DatumName,a(m),1/f,b(m),dX(m),dY(m),dZ(m),Rx(asec),Ry(asec),Rz(asec),sf(ppm)">---</option>
<option id="TWD97.2" value="TWD97,6378137,298.257222101,6356752.3141,0,0,0,0,0,0,0">TWD97</option>
<option id="TWD67.2" value="TWD67,6378160,298.25,6356774.7192,-730.16,-346.212,-472.186,-7.968,-3.5498,-0.4063,-18.2">TWD67</option>
<option id="WGS84.2" selected="" value="WGS84,6378137,298.257223563,6356752.31425,0,0,0,0,0,0,0">WGS84</option>
</select><br />
DmName: <input id="DatumName.2" name="DatumSetData" value="DatumName" />
<input onclick="addDatumOption(2)" type="button" value="add Datum" />
<input onclick="chkInputDatumData(2)" type="button" value="chkDtm2" />
<br />
<div class="css-table">
  <div class="tr">
    <div class="td">
      <div>a</div>
       <div><input id="sma.2" name="DatumSetData" value="a" /></div>
    </div>
    <div class="td">
      <div>1/f</div> 
      <div><input id="divf.2" name="DatumSetData" value="1/f" /></div>
    </div>
    <div class="td">
      <div>b </div>
      <div><input id="smb.2" name="DatumSetData" value="b" /></div>
    </div>
  </div>
  <div class="tr">
    <div class="td">
      <div>dX </div>
      <div><input id="dX.2" name="DatumSetData" value="dX" /></div>
    </div>
    <div class="td">
      <div>dY </div>
      <div><input id="dY.2" name="DatumSetData" value="dY" /></div>
    </div>
    <div class="td">
      <div>dZ </div>
      <div><input id="dZ.2" name="DatumSetData" value="dZ" /></div>
    </div>
  </div>
  <div class="tr">
    <div style="display:none" id="Ru2">
      <input value="asec"/>
      <a>asec</a><a>rad</a>
    </div>
    <div class="td">
      <div>Rx<b class="Ru2" onclick="asec_rad('Ru2')">(<a>asec</a>)</b></div>
      <div><input class= "Ru2v" id="Rx.2" name="DatumSetData" value="Rx" /></div>
    </div>
    <div class="td">
      <div>Ry<b class="Ru2" onclick="asec_rad('Ru2')">(<a>asec</a>)</b></div>
      <div><input class= "Ru2v" id="Ry.2" name="DatumSetData" value="Ry" /></div>
    </div>
    <div class="td">
      <div>Rz<b class="Ru2" onclick="asec_rad('Ru2')">(<a>asec</a>)</b></div>
      <div><input class="Ru2v" id="Rz.2" name="DatumSetData" value="Rz" /></div>
    </div>  
  </div>
  <div class="tr">
    <input style="display: none;" id="sfu2" value="ppm"/>
    <div class="td">
      <div>Scale Factor<b class="sfu2" onclick="sf_s('sfu2')">(<a>ppm</a><a style="display:none">unitless</a>)</b></div>
      <div><input class="sfu2v" id="sfppm.2" name="DatumSetData" value="sf" /></div>
    </div>  
  </div>
</div>
<div class="css-table">
  <b>Target TM setting :   </b>
<select id="TMset2slt" name="whatTMset" onchange="getSltTMdata(2)">
<option value="TMdeg,Lng0(deg),Lat0(deg),k0,FE(m),FN(m)">---</option>
<option id="TM2.2" selected="" value="TM2-121,121,0,0.9999,250000,0">TM2-121</option>
<option id="TM3.2" value="TM3-121,121,0,1,350000,0">TM3-121</option>
<option id="TM6.2" value="TM6-123,123,0,0.9996,500000,0">TM6-123</option>
<option id="TM2.2.119" value="TM2-119,119,0,0.9999,250000,0">澎湖TM2-119</option>
<option id="TM6.2.117" value="TM6-117,117,0,0.9996,500000,0">澎湖TM6-117</option>
</select>
<br />
TMset: <input id="TMdeg.2" name="tmSetData" value="TMdeg" />
  <input onclick="addTMOption(2)" type="button" value="add TM" /><br/>
<div class="tr">
    <div class="hw">Central meridian </div>
    <div><input id="Lng0.2" name="tmSetData" value="Lng0" /></div>
</div>
<div class="tr">
  <div class="hw">Central parallel </div>
  <div><input id="Lat0.2" name="tmSetData" value="Lat0" /></div>
</div>
<div class="tr">
  <div class="hw">scale factor </div>
  <div><input id="k0.2" name="tmSetData" value="k0" /></div>
</div>
<div class="tr">
  <div class="hw">False Easting </div>
  <div><input id="FE.2" name="tmSetData" value="FE" /></div>
</div>
<div class="tr">
    <div class="hw">False Northing </div>
    <div><input id="FN.2" name="tmSetData" value="FN" /></div>
</div>
</div>

</form>
<hr />
<a href="https://en.wikipedia.org/wiki/Minute_and_second_of_arc">asec:arc second</a>
<hr/>
<div>任意門:(2021.01.19 已檢查)</div>
<a href="https://wiki.osgeo.org/wiki/Taiwan_Power_Company_grid">電力座標wiki</a>
<a href="http://gis.thl.ncku.edu.tw/coordtrans/coordtrans.aspx">成大Web</a>
<a href="https://wsserver.epa.gov.tw/gis/coordtrans.aspx">環保署地理資訊MTWDCON</a>
<a href="http://webgis.sinica.edu.tw/cgi-tran/webtrans.htm">中研院(服務暫停)</a>
<a href="http://61.216.174.87/tpcGoogleMap">台電圖號座標定位系統</a>
<a href="http://www.sunriver.com.tw/taiwanmap/grid_tm2_convert.php">上河文化</a>
<a href="http://jidanni.org/geo/taipower">Jidanni</a>
<a href="https://www.defensie.nl/downloads/applicaties/2020/06/15/pctrans5_20200615">荷蘭PCTrans</a>
<a href="http://code.google.com/apis/maps/documentation/javascript/reference.html">GoogleMapAPI-js V3 Reference</a>
<a href="http://econym.org.uk/gmap/">Mike's GMapAPIv2 Tutorial</a>
</div>
<script type="text/javascript">
//<![CDATA[
// html javascript
function infoDiv(e) {
    var div = e.children[0];
    var a = 1, d = div.style.display;
    if (d == 'none' && a) div.style.display = 'inline-block', a = 0;
    if (d == 'inline-block' && a) div.style.display = 'none', a = 0;
  }

// Global var. overlayObj: map , marker , markerInfo, polyline , polygon

    var mapG;
    
    var markersG = [];
    var markersInfoG = []; 
    var polylinesG = [];    
    var polygonsG = [];

    // var geocodeRun; working

    var GoutputData = [];  // 輸出資料物件再存成全域型態
  //var GoutputDataPRN = [];

    const IconStyle1 ={'url':"http://maps.google.com/mapfiles/kml/shapes/placemark_circle.png"};
    const IconStyle2 ={'url':"http://maps.google.com/mapfiles/kml/shapes/info-i.png"};
    const IconStyle3 ={'url':"http://maps.google.com/mapfiles/kml/shapes/triangle.png"}; 

var PI = Math.PI

function POW(input,lvl){var output = Math.pow(input,lvl) ; return output;}
function SIN(input){var output = Math.sin(input) ; return output;}
function COS(input){var output = Math.cos(input) ; return output;}
function TAN(input){var output = Math.tan(input) ; return output;}
function SQRT(input){var output = Math.sqrt(input) ; return output;}
function ATAN(input){var output = Math.atan(input) ; return output;}

function ATAN2(y,x){var output = Math.atan2(y,x) ; return output;}

function deg2rad(deg){var rad = deg*PI/180 ; return rad;} // 度轉徑 func. d2r

function rad2deg(rad){var deg = rad*180/PI ; return deg;} // 徑轉度 func. r2d

function sf_ppm(s,u){
  if(u=="ppm") s = (s - 1) * 1000000  ;
  if(u=="unitless") s = 1 + s / 1000000 ;
  return s;
}
// 2021.01.25 javascript round solution
// http://www.jacklmoore.com/notes/rounding-in-javascript/
// 2021.01.30 小數位預設值與標籤識別 
function round(value, decimals) { 
  switch(decimals){
    case 'xy': decimals = 2; break;
    case 'll': decimals = 6; break;
    case undefined : decimals = 0; break;
    default: decimals = parseInt(decimals);
  }
  if(!decimals) decimals = 8;
  return Number(Math.round(value+'e'+decimals)+'e-'+decimals);
}

// 2021.03.03: rad degree switch ; sf switch
function asec_rad(n){ 
  // input value
  var div = document.getElementById(n);
  var arr = div.children;
  var unit = arr[0].value;
  var unit1 = arr[1].text;
  var unit2 = arr[2].text;
  unit = unit1, unit1=unit2, unit2=unit;
  unit = unit1;
  arr[0].setAttribute('value', unit );
  arr[1].text = unit1;
  arr[2].text = unit2;
  // name
  var arr = document.getElementsByClassName(n);
  for( var i=0; i < arr.length; i++ ){
    var a = arr[i].children[0];
    a.text = unit;
  }
  // calculate
  var a,b,func;
  if(unit=="rad") func = deg2rad, a=1/3600, b=8;
  if(unit=="asec") func = rad2deg, a=3600, b=4;
  var arr = document.getElementsByClassName(n+"v");
  for(var i=0; i < arr.length; i++){
    var input = arr[i];
    var v = parseFloat(input.value);
    input.value = round(func(v)*a,b);
  }
}
//
function sf_s(n){
  // input value
  var input = document.getElementById(n);
  var unit = input.getAttribute('value');
  // name 
  var b = document.getElementsByClassName(n)[0];
  var a0 = b.children[0], a1 = b.children[1];
  var a ="", a0t = a0.text, a1t = a1.text;
  a = a0t, a0t = a1t, a1t = a;
  a0.text = a0t, a1.text = a1t;
  input.setAttribute('value', a0t), unit = a0t;
  // calculate
  var input = document.getElementsByClassName(n+"v")[0];
  var s = parseFloat(input.value); 
  if(unit=="ppm"){
    s = sf_ppm(s,unit);
    s = round(s,2);
  } 
  if(unit=="unitless"){
    s = sf_ppm(s,unit);
    s = round(s,8);
  }
  input.value = s;
}

// Datum setting : a(m),1/f,b(m),dX(m),dY(m),dZ(m),Rx(asec),Ry(asec),Rz(asec),sf(ppm) 
const DATUM = {
'TWD67':[6378160,298.25,6356774.7192,-730.16,-346.212,-472.186,-7.968,-3.5498,-0.4063,-18.2],
'TWD97':[6378137,298.257222101,6356752.3141,0,0,0,0,0,0,0],
'WGS84':[6378137,298.257223563,6356752.31425,0,0,0,0,0,0,0]
};

// TM setting : Lng0(deg),Lat0(deg),k0,FE(m),FN(m)
const TM = {
'TM2-121':[121,0,0.9999,250000,0],
'TM3-121':[121,0,1,350000,0],
'TM6-123':[123,0,0.9996,500000,0],
'TM2-119':[119,0,0.9999,250000,0],
'TM6-117':[117,0,0.9996,500000,0]
};

//---TaipowerGlobal var.---

var GTPset1 = []
GTPset1.push("Area,BottomX,BottomY,附註")
GTPset1.push("A,170000,2750000,新竹/竹北市/桃園新豐鄉")
GTPset1.push("B,250000,2750000,台北/桃園/宜蘭北宜")
GTPset1.push("C,330000,2750000,台北貢寮/宜蘭頭城")
GTPset1.push("D,170000,2700000,苗栗/新竹")
GTPset1.push("E,250000,2700000,桃園/新竹/苗栗/宜蘭")
GTPset1.push("F,330000,2700000,宜蘭")
GTPset1.push("G,170000,2650000,北彰化/台中縣市/南苗栗/南投")
GTPset1.push("H,250000,2650000,南投/花蓮秀林/台中和平")
GTPset1.push("J,90000,2600000,雲林沿海")
GTPset1.push("K,170000,2600000,雲林/嘉義/南投")
GTPset1.push("L,250000,2600000,南投/花蓮")
GTPset1.push("M,90000,2550000,嘉義台南縣市沿海")
GTPset1.push("N,170000,2550000,南嘉義/北台南/北高雄/台東")
GTPset1.push("O,250000,2550000,台東花蓮交界")
GTPset1.push("P,90000,2500000,台南市高雄沿海")
GTPset1.push("Q,170000,2500000,北屏東/高雄/台東/南台南")
GTPset1.push("R,250000,2500000,台東/綠島?")
GTPset1.push("T,170000,2450000,屏東/台東/南高雄")
GTPset1.push("U,250000,2450000,台東太麻里/3.5公頃")
GTPset1.push("V,170000,2400000,屏東墾丁")
GTPset1.push("W,250000,2400000,(蘭嶼?)")

var GTPset2 = []
GTPset2.push("Area,BottomX,BottomY,附註")
GTPset2.push("Y,275000,2564000,澎湖南")
GTPset2.push("X,275000,2614000,澎湖北")

var GtaipowerSet = GTPset1;

var GAreaNames = getTPsetArea(); // 從 GtaipowerSet 中取出 area 的部份到 GArea

var Gallset = new Object();
Gallset.d1 = []
Gallset.d2 = []
Gallset.d1slt = 0
Gallset.d2slt = 0
Gallset.tm1 = []
Gallset.tm2 = []
Gallset.tm1slt = 0
Gallset.tm2slt = 0

//var GchkXY = ["0","1","2","3","4","5","6","7","8","9"]
var GchkArea100X = ["A","B","C","D","E","F","G","H"]
var GchkArea100Y = ["A","B","C","D","E"]

var GTPsetStatus ="none"

//-------------------------------------------------------------------------
    
      function startMap0(){
      
      var centerPoint = new google.maps.LatLng(23.74, 120.96);
      
      var mapSetting = {
      zoom: 7,
      center: centerPoint,
      scaleControl: true,
      streetViewControl: true,
      mapTypeId: google.maps.MapTypeId.ROADMAP
      }; 
      // 放大值,中心點,比例尺,街景功能,地圖種類(一定要有)
      
      mapG = new google.maps.Map(document.getElementById("map0"), mapSetting);

      google.maps.event.addListener(mapG,'click',function(event){
       getEventMarkerInfo(event); } 
      );
      
      // let icon size smaller
      IconStyle2['scaledSize']=new google.maps.Size(25,25);        
      IconStyle3['scaledSize']=new google.maps.Size(25,25);        
      
} // func. start_map0

//-------------------------------------------------------------------------

function geocodePOS(){

var address = document.getElementById("geocodeInput").value
var MapG = mapG

var geocoder = new google.maps.Geocoder();

geocoder.geocode( {'address': address} , 
function(results, status){
      if (status == google.maps.GeocoderStatus.OK){
      
        var pos = results[0].geometry.location
        var address = results[0].formatted_address
        
      var infoObj = get_84_97_67_TPName_info(pos);
      var html = infoObj.html + "<br/>" + address
      var cmt = address + "\n" + infoObj.cmt 
        
        var box = results[0].geometry.viewport
            
        MapG.setCenter(pos);
        createMarker(MapG,pos,html,cmt,"",IconStyle2);      
        MapG.fitBounds(box);
        
}else{alert("Geocode failed : " + status); }
                       } // callback func.
                );

} // func. geocodePOS

//-------------------------------------------------------------------------

function getEventMarkerInfo(event){
      var latlng = event.latLng
      
      var lat1 = latlng.lat() ; 
      var lng1 = latlng.lng() ;
      
      var bakTPset = GtaipowerSet
    if(lng1 >= 120 && lng1 < 126 ){ GtaipowerSet = GTPset1; }
    if(lng1 >= 114 && lng1 < 120 ){ GtaipowerSet = GTPset2; }
    // 檢查 lng 值來設定 台電查表
          
      var infoObj = get_84_97_67_TPName_info(latlng);
      
      var mk1info = infoObj.html
      var mk1cmt = infoObj.cmt 
      
      // process2: geocode 的部份暫時不能寫在 func 內，
      // 因為return 在先 而 geocode 在後 之故，目前還不知如何傳出參數
    
    var MapG = mapG ;
    
    if(document.getElementById("geocodeCHK").checked){
    
     var geocoder = new google.maps.Geocoder();
        
    var t1 = new Date() // geocode 計時   
    // GeoCode 開始
    geocoder.geocode({'latLng': latlng},function(results, status){ 

     var response ; 
     if (status == google.maps.GeocoderStatus.OK) {
        if (results[0]) { 
        response = results 
          } else {alert("No results found"); }
     }else{ alert("Geocoder failed : " + status); }
         
     if(response){
     var GCaddress = response[0].formatted_address ; // 0層最詳細
     var GClatlng = response[0].geometry.location ; //地址記載座標
     }
     else{ var GCaddress = "[geocode error]" ; var GClatlng = latlng }
      
     var GClat = GClatlng.lat() ;
     var GClng = GClatlng.lng() ;
     
     var GCinfo = GClat + GClng + "<br/>" + "抓取的地址位置置" ;
     var GCcmt = GClat+","+GClng ;
     
     mk1cmt += "\n"+GCaddress ;
     
     var t2 = new Date(); // geocode後的時間
     var timecost = "(" + (t2 - t1) + "ms)" ; // 相減得時間差 ms
     mk1info += "<br/>"+"地址: " + GCaddress + timecost;
        
     createMarker(MapG,GClatlng,GCinfo,GCcmt,"",IconStyle2); // geocode
     
     createMarker(MapG,latlng,mk1info,mk1cmt,"open",IconStyle2); //click
     
     createPolyline([latlng,GClatlng]); // click -line-> geocode

         } // callback func. 如此 createMarker 得於 geocoder 之後，有時間差
      ); // geocoder 本身會慢些處理，如有要繼續執行的程式，則寫在之後
    // end of process2
    }else{
      createMarker(MapG,latlng,mk1info,mk1cmt,"open",IconStyle2); //click
    }
    
    // 其他檢查 10m 100m 800x500 是否要生成
    
    if(document.getElementById("area10m").checked){
    getXmYm2gmapSub(infoObj.pt, 10,10);    
    } 
    
    if(document.getElementById("area100m").checked){
    getXmYm2gmapSub(infoObj.pt, 100,100);    
    } 
    
    if(document.getElementById("area800x500m").checked){
    getXmYm2gmapSub(infoObj.pt, 800,500);    
    } 
    
    GtaipowerSet = bakTPset // 還原設定
    
} // func. getEventMarkerInfo
// http://code.google.com/apis/maps/documentation/javascript/examples/geocoding-reverse.html      

//-------------------------------------------------------------------------
//-------------------------------------------------------------------------

function get_84_97_67_TPName_info(latlng){ 

    var lat1 = latlng.lat() ; 
    var lng1 = latlng.lng() ;
     
    var p84 = calcWGS84_67_97Sub(lat1,lng1);
    
    var LL1 = round(lat1,'ll')+","+round(lng1,'ll');
    var LL1utm = round(p84.utm.X,'xy')+","+round(p84.utm.Y,'xy');
    var LL2 = round(p84.LLh2.LatY,'ll')+","+round(p84.LLh2.LngX,'ll');
    var xy2 = round(p84.tmXY2.X,'xy')+","+round(p84.tmXY2.Y,'xy');
    var LLh97 = round(p84.LLh97.LatY,'ll')+","+round(p84.LLh97.LngX,'ll');
    var xy97 = round(p84.tmXY97.X,'xy')+","+round(p84.tmXY97.Y,'xy');
    
    TPname = calc67getTPowerSub(p84.tmXY2.X,p84.tmXY2.Y)
       
    var mk1info = [] ;
    mk1info.push("WGS84: "+LL1)
    mk1info.push("UTM: "+LL1utm)
    mk1info.push("TWD97: "+LLh97)
    mk1info.push("TWD97xy: "+xy97)
    mk1info.push("TWD67: "+LL2)
    mk1info.push("TWD67xy: "+xy2)
    mk1info.push("可能電力座標: "+TPname)
    
    var mk1cmt = TPname + " ";  
    
    var infoObj = new Object()
    infoObj.html = mk1info.join("<br/>")
    infoObj.cmt = mk1cmt
    infoObj.pt = p84
    
    return infoObj 
    } // func. get84_97_67_TPName_info(latlng)

//-------------------------------------------------------------------------

function createPolyline(latlngObj){

if(polylineCHK(latlngObj) == true){

 var cline = new google.maps.Polyline({ // click -> geocode
        path: latlngObj,
        strokeColor: "#00FF00",
        strokeOpacity: 0.5,
        strokeWeight: 3  });
     
     var MapG = mapG ;   
     cline.setMap(MapG) ; 
     //alert(latlngObj[0] == cline.getPath().getAt(0))
     
     var PolylinesG = polylinesG
     PolylinesG.push(cline) ; // Global 管理

 } // if
} // func. createPolyline

//-------------------------------------------------------------------------
// 兩點檢查重複的polyline
function polylineCHK(latlngObj){

var result = true
var PolylinesG = polylinesG

if( PolylinesG.length > 0 ){ 

var latlngObj0 = latlngObj[0].toString()
var latlngObj1 = latlngObj[1].toString()
for(var i=0 , num=PolylinesG.length ; i < num ; i++){

if(PolylinesG[i].getPath().getAt(0).toString() == latlngObj0
&& PolylinesG[i].getPath().getAt(1).toString() == latlngObj1 )
{ addSettingView("find the same polyline at "+i );
  result = false ; }

  } // for polylinesG

} // if

return result
} // func. polylineCHK

//-------------------------------------------------------------------------
//map , 座標, info內容, title顯示, 檢查項 open = 產生點就開啟 info窗
function createMarker(map,latlng,html,cmt,chk,style){

var MarkersG = markersG ; var MarkersInfoG = markersInfoG ; // 取用 Global var.
var MarkerNumObj = document.getElementById("markerNum")
var marker, MapG = mapG ;

if(markerCHK(latlng) == true){

marker = new google.maps.Marker(
    { position: latlng,
      map: map,
      icon: style,
      title: cmt } ); //座標,地圖,title:移上點位時顯示黃底小框之資訊

   // marker 事件：
    google.maps.event.addListener(marker, 'click', function()
     { closeAllMarkerInfo();              // 關閉所有 info
       marker_info.open(MapG,marker);     // 開啟click marker 的 info
       getMarkerPOShtml(marker);        // 顯示這是第幾個 marker 
     } );

MarkersG.push(marker); //送至全域 做管理    
    
    var marker_info = new google.maps.InfoWindow(
    {content: html} );

    if(chk == "open"){
    closeAllMarkerInfo() // 關閉所有 info   
    marker_info.open(MapG,marker); // 剛產生的 marker開info窗
    } // if chk  

MarkersInfoG.push(marker_info); // Global markersInfo

MarkerNumObj.value = MarkersG.length // marker總數顯示更新
getMarkerPOShtml(marker) // 查詢此 marker 是第幾個，並更新 html

  } // if

return marker;
}// func. createMarker 

//-------------------------------------------------------------------------
// 檢查重複的 marker(by latlng)
function markerCHK(latlng){

var result = true
var MarkersG = markersG // 避免一直重複使用全域變數，取過來再用

if( MarkersG.length > 0 ){

var latlngStr = latlng.toString()
for(var i = 0 , num=MarkersG.length ; i < num ; i++){
if(MarkersG[i].getPosition().toString() == latlngStr )
{ addSettingView("find the same marker at "+i );
  result = false ; }
                    } // for
    } // if

return result
}

//-------------------------------------------------------------------------
// 查詢 marker集合 比對得知是第幾個 marker
function getMarkerPOShtml(marker){

var MarkersG = markersG
var MarkerPOS = document.getElementById("markerPOS")

for(var i=0 , num=MarkersG.length ; i < num ; i++){
if(marker == MarkersG[i])
{ MarkerPOS.value = parseInt(i)+1 }
  } // for i 
} // func. getMarkerPOShtml

//-------------------------------------------------------------------------
// 關閉所有 marker info 窗
function closeAllMarkerInfo(){

var MarkersInfoG = markersInfoG ;

if(MarkersInfoG.length > 0) 
       {for(var i = 0 , num = MarkersInfoG.length ; i < num ; i++)
       {MarkersInfoG[i].close() } }; 
} // func. closeAllMarkerInfo

//-------------------------------------------------------------------------
// 處理 prev del next 按鈕對應的功能
function markersGControl(set){
var markerPOSobj = document.getElementById("markerPOS")
var markerNumobj = document.getElementById("markerNum") // 取POS,Num 物件
var mPOS = parseInt(markerPOSobj.value) // 取值

var MarkersG = markersG // 取全域變數
var MarkersInfoG = markersInfoG

//if(markerPOS > 0 && markerPOS <= markersG.length ){
// 所有功能必須在 至少有1個 marker 且不大於 marker總數
if(set == 'prev' && mPOS > 1){
// prev 至少 marker 要 2 個以上
markerPOSobj.value = parseInt(markerPOSobj.value) - 1// 目前第幾個退一個
openMarkerInfoByPOS()
  }
if(set == 'next' && mPOS < MarkersG.length){
// next 則當 marker 編號=總數時 = max 不能再有下一個
markerPOSobj.value = parseInt(markerPOSobj.value) + 1
openMarkerInfoByPOS()
  }
if(set == 'del' && mPOS > 0 && MarkersG.length > 0){
// 至少要有一個 marker 才能刪除
var i = parseInt(markerPOSobj.value) -1
MarkersInfoG[i].close()  // info 關閉
MarkersG[i].setMap(null) // marker set null
MarkersInfoG.splice(i,1) // 矩陣也 remove
MarkersG.splice(i,1)
if(i == 0 && MarkersG.length > 0){i = 1}
markerPOSobj.value = i   // 更新目前位置
markerNumobj.value = MarkersG.length // 更新總數
openMarkerInfoByPOS(); 
// 至少要有 2-1 = 1 marker 才需要開 info 窗
  }

//}else{alert("error"); }

} // func. markersGControl

//-------------------------------------------------------------------------

function openMarkerInfoByPOS(){

var MarkersG = markersG ; var MarkersInfoG = markersInfoG
var MapG = mapG

var i = parseInt(document.getElementById("markerPOS").value)
var k = MarkersG.length
if(i > 0 && i <= k ){closeAllMarkerInfo(); // 關閉所有info窗
MarkersInfoG[i-1].open(MapG,MarkersG[i-1]); }
}

//-------------------------------------------------------------------------
// 清除 marker , markerinfo , polyline , polygon 
function clearAlloverlays(){

var MarkersG = markersG
var MarkersInfoG = markersInfoG
var PolylinesG = polylinesG
var PolygonsG = polygonsG

if(markersG){
for(var i=0 , num=MarkersG.length ; i < num ; i++)
{MarkersG[i].setMap(null); }
MarkersG.length = 0 ; 
} // if markersG

document.getElementById("markerNum").value = 0
document.getElementById("markerPOS").value = 0

if(MarkersInfoG){
for(var i=0 , num=MarkersInfoG.length ; i < num ; i++)
{MarkersInfoG[i].close(); }
MarkersInfoG.length = 0 ; } // if markersInfoG

if(PolylinesG){
for(var i=0 , num=PolylinesG.length ; i < num ; i++)
{PolylinesG[i].setMap(null); }
PolylinesG.length = 0 ; } // polylinesG

if(PolygonsG){
for(var i=0 , num=PolygonsG.length ; i < num ; i++)
{PolygonsG[i].setMap(null); }
PolygonsG.length = 0 ; } // if polygonsG

} // func. clearAlloverlay

//-------------------------------------------------------------------------

function getXmYm2gmapSub(pt,setX,setY){
// 也是要偵測 taiwan or penghu
var lat = pt.LLh2.LatY, lng = pt.LLh2.LngX;
var x = pt.tmXY2.X, y = pt.tmXY2.Y;
var d1 = 'TWD67', d2 = 'WGS84', t1='TM2-121', t2='TM6-123';

if(lng >= 120 && lng < 122) t1='TM2-121';
if(lng >= 118 && lng < 120 ) t1='TM2-119';

// setXY = (10,10) or (100,100) 對於電力座標數據，只有百位以下才能這麼做

if(setX == 800 && setY == 500){

 areaObj = getAreaNameByXY(x,y) // x,y 查所在處所屬 area
 // 還是得知道大區起點值才行，似乎有比例關係 T = area + 800x + 100y + z
 // area 會影響 x,y 
 var xMod = x - parseInt(areaObj.x)
 var yMod = y - parseInt(areaObj.y)

 var xx = parseInt( xMod/800 ) 
 var yy = parseInt( yMod/500 )

 var xDL = parseInt(areaObj.x) + xx*800
 var yDL = parseInt(areaObj.y) + yy*500

 }else{ // 10 or 100
 var xDL = parseInt(x/setX)*setX 
 var yDL = parseInt(y/setY)*setY
}

var xDR = xDL + setX ; var yDR = yDL ;

var xUR = xDL + setX ; var yUR = yDL + setY ;

var xUL = xDL ; var yUL = yDL + setY ;

var xyDL = tp_tm2llh(xDL,yDL,0,'',d1,d2,t1,t2)
var xyDR = tp_tm2llh(xDR,yDR,0,'',d1,d2,t1,t2)
var xyUR = tp_tm2llh(xUR,yUR,0,'',d1,d2,t1,t2)
var xyUL = tp_tm2llh(xUL,yUR,0,'',d1,d2,t1,t2)

var lat   = xyDL.p2.LatY ; var lng   = xyDL.p2.LngX
var latDR = xyDR.p2.LatY ; var lngDR = xyDR.p2.LngX
var latUR = xyUR.p2.LatY ; var lngUR = xyUR.p2.LngX
var latUL = xyUL.p2.LatY ; var lngUL = xyUL.p2.LngX

var latlng = new google.maps.LatLng(lat,lng)
var latlngDR = new google.maps.LatLng(latDR,lngDR)
var latlngUR = new google.maps.LatLng(latUR,lngUR)
var latlngUL = new google.maps.LatLng(latUL,lngUL)

createPolyline([latlng,latlngDR,latlngUR,latlngUL,latlng]);

}

function addSettingView(msg){
var obj_settingView = document.set0.settingView ;
//obj_settingView.innerText += "\r\n" + msg ;
obj_settingView.value += "\r\n" + msg ;

obj_settingView.scrollTop = obj_settingView.scrollHeight
}// func. addSettingView

function ascendNum(a,b){return a-b} // 小到大
function descendNum(a,b){return b-a} // 大到小 供 array.sort(sortFunc.) 用

//-------------------------------------------------------------------------

function getTPsetArea(){
inputObj =  getInputObj(GtaipowerSet)
inputObj.shift() // 不要第一行

var areaNames = []

for(var i = 0 , num=inputObj.length ; i < num ; i++)
{areaNames.push(inputObj[i][0]); } // 取每行第一個

return areaNames
} // func. getTPsetArea

//-------------------------------------------------------------------------

function getTPset2GMap(){
// Taiwan: TWD67-TM2-121 轉 WGS84-TM2-121
// PengHu: TWD67-TM2-119 轉 WGS84-TM2-119
// 偵測目前 Tipower 表單(台灣 OR 澎湖)
var TPsetSlt = document.getElementById("quickTPsetSlt").value

var d1,d2,t1,t2;
if(TPsetSlt == "TPset1" ) d1 = 'TWD67', t1='TM2-121', d2 = 'WGS84', t2 = 'TM2-121';


if(TPsetSlt == "TPset2" ) d1 = 'TWD67', t1='TM2-119', d2 = 'WGS84', t2 = 'TM2-119';

//固定會去掉 矩陣第一列，每列第一個，超過 5 個都去除
inputObj =  getInputObj(GtaipowerSet)
inputObj.shift() // 砍掉第一列註解行

for(var i = 0 , num=inputObj.length ; i < num ; i++){

var cmt = inputObj[i][0] + ";" + inputObj[i][3]
// 0=分區名 加到註解前面 1=x 2=y 3=cmt

inputObj[i].shift(); // 砍掉每列第一個 , 如此 0=x 1=y 2=cmt
inputObj[i].splice(2,0,0); // 在 1=y 後面,不移除,插入一個 0,2=h=0 , 3=cmt
inputObj[i][3] = cmt; 
inputObj[i][4] = "xy" ; // 0=x 1=y 2=h=0 3=cmt 4=chk (5)

} // for i

//建立xy四角點位物件: 67x+80000 67y+50000
var pointObj = new Array()
for(var i = 0 , num=inputObj.length ; i < num ; i++ ){

pointObj[i] = new Object()

// origin point : DownLeft
pointObj[i].x = inputObj[i][0]
pointObj[i].y = inputObj[i][1]
pointObj[i].h = inputObj[i][2]
pointObj[i].cmt = inputObj[i][3]
pointObj[i].chk = inputObj[i][4] ;

// DownRight : x+80000
pointObj[i].DRx = parseInt( inputObj[i][0] ) + 80000
pointObj[i].DRy = inputObj[i][1]
pointObj[i].DRh = inputObj[i][2]
pointObj[i].DRcmt = inputObj[i][3] + ":DownRight"
pointObj[i].DRchk = inputObj[i][4] ;


// UpperRight : x+80000 y+50000
pointObj[i].URx = parseInt( inputObj[i][0] ) + 80000
pointObj[i].URy = parseInt( inputObj[i][1] ) + 50000
pointObj[i].URh = inputObj[i][2]
pointObj[i].URcmt = inputObj[i][3] + ":UpperRight"
pointObj[i].URchk = inputObj[i][4] ;

// UpperLeft : y+50000
pointObj[i].ULx = inputObj[i][0]
pointObj[i].ULy = parseInt( inputObj[i][1] ) + 50000
pointObj[i].ULh = inputObj[i][2]
pointObj[i].ULcmt = inputObj[i][3] + ":UpperLeft"
pointObj[i].ULchk = inputObj[i][4] ;

} // for i 建立四角點位物件


// 建立 pointObj84 物件並 run pointObj 一次轉 67xy 2 84llh
var pointObj84 = new Array() 

for(var i = 0 , num=pointObj.length ; i < num ; i++ ){

pointObj84[i] = new Object() ;
// origin
var x = pointObj[i].x ; var y = pointObj[i].y ; var h = pointObj[i].h ;
var out = tp_tm2llh(x,y,h,'',d1,d2,t1,t2) ;
// out.p1 = LLh1(ex.67) out.p2 = LLh2(ex.84)
var fix = chkTM1CMsetFix84llh(out,d1,d2,t1,t2)
// ex.檢查 lng 於 TM2中央經線 = 121 時，是否小於 67-120 度 大於 67-122度

pointObj84[i].x = fix.p2.LatY
pointObj84[i].y = fix.p2.LngX
pointObj84[i].h = fix.p2.h
pointObj84[i].cmt = pointObj[i].cmt
pointObj84[i].chk = pointObj[i].chk ;

// DownRight : x+80000
var x = pointObj[i].DRx ; var y = pointObj[i].DRy ; var h = pointObj[i].DRh ;
var out = tp_tm2llh(x,y,h,'',d1,d2,t1,t2) ;
var fix = chkTM1CMsetFix84llh(out,d1,d2,t1,t2) ;

pointObj84[i].DRx = fix.p2.LatY
pointObj84[i].DRy = fix.p2.LngX
pointObj84[i].DRh = fix.p2.h   

// UpperRight : x+80000 y+50000
var x = pointObj[i].URx ; var y = pointObj[i].URy ; var h = pointObj[i].URh ;
var out = tp_tm2llh(x,y,h,'',d1,d2,t1,t2) ;
var fix = chkTM1CMsetFix84llh(out,d1,d2,t1,t2) ;

pointObj84[i].URx = fix.p2.LatY
pointObj84[i].URy = fix.p2.LngX
pointObj84[i].URh = fix.p2.h   

// UpperLeft : y+50000
var x = pointObj[i].ULx ; var y = pointObj[i].ULy ; var h = pointObj[i].ULh ;
var out = tp_tm2llh(x,y,h,'',d1,d2,t1,t2) ;
var fix = chkTM1CMsetFix84llh(out,d1,d2,t1,t2) ;

pointObj84[i].ULx = fix.p2.LatY
pointObj84[i].ULy = fix.p2.LngX
pointObj84[i].ULh = fix.p2.h   

} // for i 將 tm67xyh 轉 wgs84llh


// 建立面積物件 + 計算中央點物件
alert("Add TaiwanPowerArea! "); var MapG = mapG

for(var i = 0 , num=pointObj84.length ; i < num ; i++ ){

var lat = pointObj84[i].x
var lng = pointObj84[i].y // 左下

var latDR = pointObj84[i].DRx 
var lngDR = pointObj84[i].DRy //右下

var latUR = pointObj84[i].URx 
var lngUR = pointObj84[i].URy //右上

var latUL = pointObj84[i].ULx
var lngUL = pointObj84[i].ULy // 左上

var latlng = new google.maps.LatLng(lat,lng)
var latlngDR = new google.maps.LatLng(latDR,lngDR)
var latlngUR = new google.maps.LatLng(latUR,lngUR)
var latlngUL = new google.maps.LatLng(latUL,lngUL)

 // 建立 Polygon 
createPolygon([latlng,latlngDR,latlngUR,latlngUL,latlng])

// 建立中央點
var latCEN = (lat + latUR)/2
var lngCEN = (lng + lngUR)/2
var cmt = pointObj84[i].cmt
var latlngCEN = new google.maps.LatLng(latCEN,lngCEN)
 
  createMarker(MapG,latlngCEN,cmt,cmt,"",IconStyle3)

   } // for i 計算所有 pointObj84

} // func. getTPset2GMap 

//----------------------------------------------------------------

function createPolygon(latlngObj){
if( polygonCHK(latlngObj) == true ){

   var polygon = new google.maps.Polygon(
   {paths: latlngObj,
    strokeColor: "#00FF00",
    strokeOpacity: 0.3,
    strokeWeight: 3,
    fillColor: "#00FF00",
    fillOpacity: 0.1
    } );       // API v3 
        
        var MapG = mapG ;
polygon.setMap(MapG);

google.maps.event.addListener( polygon,"click", 
function(event){getEventMarkerInfo(event); } 
      ) ; // polygon 在 overlay 上被點到也需要事件處理

var PolygonsG = polygonsG
PolygonsG.push(polygon); // Global polygons 管理

    } // if
    
} // func. createPolygon

//----------------------------------------------------------------

function polygonCHK(latlngObj){

var result = true ; var PolygonsG = polygonsG ;

if(PolygonsG.length > 0 ){ 

var latlng0 = latlngObj[0].toString();
var latlng1 = latlngObj[1].toString();
for(var i=0 , num=PolygonsG.length ; i < num ; i++ ){

if(PolygonsG[i].getPath().getAt(0).toString() == latlng0
&& PolygonsG[i].getPath().getAt(1).toString() == latlng1 )
 { addSettingView("find the same polygon at "+i ); 
   result = false; }

    } // for polygonsG

 } // if

return result
} // func. polygonCHK

//----------------------------------------------------------------

function tp_tm2llh(x,y,h,chk,d1,d2,t1,t2){
// 供 Taipower 表單轉換: 67xy轉 84llh ，分區四角點

var objLLh1 = new Object();      

  if(chk == "LLh"){           // chk = LLh 時 xyh 轉浮點 LLh1
  objLLh1.LatY = parseFloat(x)
  objLLh1.LngX = parseFloat(y)
  objLLh1.h = parseFloat(h)  
  }
  else{objLLh1 = tmXY2LLh(x, y, h, 1, d1,t1);} //進來平面xyh 轉 LLh1
  // if chk
    
  var objXYZ1 = LLh2XYZ(objLLh1.LatY, objLLh1.LngX, 0, 1, d1);
  var objXYZ0 = XYZ2XYZ(objXYZ1.X, objXYZ1.Y, objXYZ1.Z, 1, d1);
  var objXYZ2 = XYZ2XYZ(objXYZ0.X, objXYZ0.Y, objXYZ0.Z, 2, d2); 
  var objLLh2 = XYZ2LLh(objXYZ2.X, objXYZ2.Y, objXYZ2.Z, 2, d2);

var output = new Object()
output.p1 = objLLh1
output.p2 = objLLh2

return output
}

//-------------------------------------------------------------------------

function chkTM1CMsetFix84llh(objLLh,d1,d2,t1,t2){
// 傳入的 LLh 檢查是否超出 source=set1 CM=Lng0+- 的範圍
var Lng0 = TM[t1][0];
var FE = TM[t1][3];

var Lng0max ; var Lng0min ; // ex. Lng0 = 121 , taiwan 

// objLLh.p1 objLLh.p2  
var lat1 = objLLh.p1.LatY ; var lng1 = objLLh.p1.LngX ; var h1 =objLLh.p1.h ;

var lat2 = objLLh.p2.LatY ; var lng2 = objLLh.p2.LngX ; var h2 =objLLh.p2.h ;
// ex. llh1 = 67,Lng0=121 , llh2 = 84

if(FE == 250000)
{Lng0max = Lng0 + 1 ; Lng0min = Lng0 - 1}
else if(FE == 350000)
{Lng0max = Lng0 + 1 ; Lng0min = Lng0 - 2}
else if (FE == 500000)
{Lng0max = Lng0 +3 ; Lng0min = Lng0 - 3}
else
{Lng0max = Lng0 + 1 ; Lng0min = Lng0 - 1} // 預設正負2度

var out1 = tp_tm2llh(lat1,Lng0max,h1,"LLh",d1,d2,t1,t2)
var out2 = tp_tm2llh(lat1,Lng0min,h1,"LLh",d1,d2,t1,t2) 
// 其實是 LLh1 轉 LLh2 , 得注意來源目的設定是否為 67,84
var Lng84Max = out1.p2.LngX
var Lng84Min = out2.p2.LngX

if(lng2 > Lng84Max){ objLLh.p2.LngX = Lng84Max ; }
if(lng2 < Lng84Min){ objLLh.p2.LngX = Lng84Min ; }
// 如果傳入的 lng(1=67,2=84) 大於或小於 ex. cm=121+-1=120,122 則無意義
// 就用 max min 代換  

return objLLh
}

//---Taipower func.------------------------------------
//2021.03.05: Taipower to TWD67-TM2-xy
function getXY_TPnA(area){
  var r = {'x':0,'y':0};
  var chk = function(line){
    var arr = line.split(',');
    if(area == arr[0]) r['x'] = arr[1]*1, r['y'] = arr[2]*1;
  };
  for(var i=0;i<GTPset1.length;i++) chk(GTPset1[i]);
  return r;
}

function getXY_TPn5(tpname){
  var arr = tpname.split('');
  var area = arr[0];
  var xx = arr[1] + arr[2];
  var yy = arr[3] + arr[4];
  var r = getXY_TPnA(area);
  r['x']+=parseInt(xx)*800, r['y']+=parseInt(yy)*500;
  return r;
}

function getXY_TPn7(tpname){
  var arr = tpname.split('');
  var x100N = arr[5].toUpperCase(); 
  var y100N = arr[6].toUpperCase();
  var r = getXY_TPn5(tpname);
  var x100 = GchkArea100X.findIndex((a)=>a==x100N);
  var y100 = GchkArea100Y.findIndex((a)=>a==y100N);
  r['x']+=x100*100, r['y']+=y100*100;
  return r; 
}

function getXY_TPn9(tpname){
  var arr = tpname.split('');
  var x10 = parseInt(arr[7]);
  var y10 = parseInt(arr[8]);
  var r = getXY_TPn7(tpname);
  r['x']+=x10*10, r['y']+=y10*10;
  return r; 
}

function getXY_TPn11(tpname){
  var arr = tpname.split('');
  var x1 = parseInt(arr[9]);
  var y1 = parseInt(arr[10]);
  var r = getXY_TPn9(tpname);
  r['x']+=x1*1, r['y']+=y1*1;
 return r;
}

function callTPSet(set){
// 取出內建查表傳入訊息區，如果 xyset 勾選了，將查表物件傳入 xysetCreate() 處理
var objMsgArea = document.getElementById("settingView") // 取 訊息欄
var objchkBox = document.getElementById("xyset")  // 取 chkbox
var objBtnCngTPSet = document.getElementById("CngTPSet")

if(set == 0){}
if(set == 1){GtaipowerSet = GTPset1; }
if(set == 2){GtaipowerSet = GTPset2; }

if(objchkBox.checked){ // 如果xyset打勾
tmp = xysetCreate( getInputObj(GtaipowerSet)); 
//另將查表'物件'送去做處理
//objMsgArea.innerText = tmp
objMsgArea.value = tmp ; GTPsetStatus = "xy" ; } // 設定 查表狀態 為 xy
else{
GTPsetStatus = "list"; // 沒有xyset的送出 查表狀態一定是 list 
if( !objchkBox.checked ) // 如果xyset沒有打勾
{objBtnCngTPSet.removeAttribute('disabled');} // 才允許變更設定

//objMsgArea.innerText = GtaipowerSet ; 
objMsgArea.value = GtaipowerSet.join("\r\n") // firefox
    } // else objchkBox

} // func. callTPSet()

//-------------------------------------------------------------------------

function callTPsetSlt(){
var TPsetSlt = document.getElementById("quickTPsetSlt").value

if(TPsetSlt == "TPset1" ) callTPSet(1); 
  //callQuickSet("set67to97"); }

if(TPsetSlt == "TPset2" ) callTPSet(2); 
//callQuickSet("set67to97PH"); }

} // func. callTPsetSlt

//-------------------------------------------------------------------------

function changeTPSet(){ // 變更設定
var cngProtectAsk = confirm("SURELY Change Setting?")
if(cngProtectAsk == true){
var objMsgAreaStr = document.getElementById("settingView").value // 取 訊息欄
GtaipowerSet = objMsgAreaStr.split("\r\n");

GAreaNames = getTPsetArea(); // 更新 GArea
  } // if
} // func. changeTPSet()

//-------------------------------------------------------------------------

function xysetCreate(inputObj){
// 傳入的是Gtaipower查表'物件' 篩選xy項 建立 xyArea物件,填入分區名
// 傳出轉換了顯示方式的查表string

var tmpClt = new Object()
tmpClt.x = []; 
tmpClt.y = [];

var btm = new Object()
btm.x = []; 
btm.y = [];   // 建立物件

for(var i = 1 ; i < inputObj.length ; i++)
{
tmpClt.x.push(inputObj[i][1]) // 收集 x
tmpClt.y.push(inputObj[i][2]) // 收集 y
} // for i

tmpClt.x.sort(ascendNum)
tmpClt.y.sort(ascendNum) // 排序，小到大

for(var i = 0 ; i < tmpClt.x.length ; i++)
{
if(tmpClt.x.length == 1){btm.x.push(tmpClt.x[i])}
else if(tmpClt.x.length == 2 && tmpClt.x[i] != tmpClt.x[i+1])
{btm.x.push(tmpClt.x[i]);btm.x.push(tmpClt.x[i+1]);break;}
else if(tmpClt.x.length == 2 && tmpClt.x[i] == tmpClt.x[i+1])
{btm.x.push(tmpClt.x[i]);break;}
else if(i + 1 < tmpClt.x.length && tmpClt.x[i] != tmpClt.x[i+1])
{btm.x.push(tmpClt.x[i])} // 01 12 23 34 ...
else if(i + 1 == tmpClt.x.length - 1 && tmpClt.x[i] == tmpClt.x[i+1])
{btm.x.push(tmpClt.x[i]);} // 最後一筆，不相等表示最後兩筆都需要
}//for x 如果第0 不等於第1，就傳回第0 且處理編號不大於總長
// 用來排除相同的 x 項目，儲存相異的 x 項目

for(var i = 0 ; i < tmpClt.y.length ; i++)
{
if(tmpClt.y.length == 1){btm.y.push(tmpClt.y[i])}
else if(tmpClt.y.length == 2 && tmpClt.y[i] != tmpClt.y[i+1])
{btm.y.push(tmpClt.y[i]);btm.y.push(tmpClt.y[i+1]);break;}
else if(tmpClt.y.length == 2 && tmpClt.y[i] == tmpClt.y[i+1])
{btm.y.push(tmpClt.y[i]);break;}
else if(i + 1 < tmpClt.y.length && tmpClt.y[i] != tmpClt.y[i+1])
{btm.y.push(tmpClt.y[i])} // 01 12 23 34 ...
else if(i + 1 == tmpClt.y.length - 1 && tmpClt.y[i] == tmpClt.y[i+1])
{btm.y.push(tmpClt.y[i]);} // 最後一筆，不相等表示最後兩筆都需要
}//for y ， 收集不重複的 y 項目，小到大

btm.y.reverse() // y 反轉，大到小

function findx(inputData){
var num = 0
for(var k = 0 ; k < btm.x.length ; k++)
{if(inputData == btm.x[k]){num = k;} } // for k
return num;
} // func. findx , 

function findy(inputData){
var num = 0
for(var k = 0 ; k < btm.y.length ; k++)
{if(inputData == btm.y[k]){num = k;} } // for k
return num; 
} // func. findy 有了 btm x,y 將輸入值傳入判別位於第幾項

var xyArea = new Array(btm.y.length) // 共 y 行
for(var i = 0 ; i < btm.y.length ; i++){xyArea[i] = new Array(btm.x.length)} 
// 每行 x 個 , 建立二維矩陣 xyArea[y][x]
for(var i = 0 ; i < xyArea.length ; i++)
{for(var j = 0 ; j < xyArea[i].length ; j++){xyArea[i][j] = "     "}}
// 全部填 5空白

for(var i = 1 ; i < inputObj.length ; i++)
{
area = inputObj[i][0]
x = findx(inputObj[i][1])
y = findy(inputObj[i][2])
xyArea[y][x] = area+"    " 
} // for i , 輸入查表資料x,y 查得對應位置，填入 xyArea矩陣

for(var i = 0 ; i < xyArea.length ; i++)
{
xyArea[i].splice(0,0,btm.y[i])
} // 每行第一個加入 btm.y 值 , 補上 Area 側欄y

xyArea.splice(0,0,"AreaY\\X"+","+btm.x) // btm.x 加到第一行j,頂欄x

xyArea = xyArea.join("\r\n") // 矩陣斷行以供顯示

return xyArea // i
} // func. xysetCreate

//-------------------------------------------------------------------------

function disableCngTPSet() // [變更設定]鈕 取消功能
{
var objXYsetChk = document.getElementById("xyset")
var objBtnCngTPSet = document.getElementById("CngTPSet")

if(objXYsetChk.checked) // 如果 xyset 核取
{objBtnCngTPSet.setAttribute('disabled','enbled')} //就一定變更設定不准
else if(!objXYsetChk.checked && GTPsetStatus == "list")
{objBtnCngTPSet.removeAttribute('disabled')} // 反之 但查表狀態 = list，允許變更

} // diaableCngTPSet
//-------------------------------------------------------------------------

function calc67getTPowerSub(x,y){

x = parseInt(x)
y = parseInt(y) // 字串轉浮點取整數

areaObj = getAreaNameByXY(x,y) // x,y 查所在處所屬 area

var area = areaObj.name

var xMod = x - areaObj.x

var yMod = y - areaObj.y

// --- x ---

var xx = parseInt( xMod/800 ) // --> 這裡求得圖號 xx
if(xx < 10){xx = "0"+xx.toString();} // 小於 10 不到兩位 換成字串前補0

var xxMod = xMod%800             // --> 剩下的部份， 

var x3 = parseInt(xxMod/100) // --> 再除以 100，得百分位分區 x: A~H , 0~7
var x3n = GchkArea100X[x3]

var x3Mod = xxMod%100 // --> 剩下的部份，
var x2 = parseInt(x3Mod/10)   //--> 再除以 10，得十分位
var x1 = parseInt(x3Mod%10) //--> 最後剩下的部份就是個位數了

// --- y ---

var yy = parseInt( yMod/500 ) // --> 這裡求得圖號 yy
if(yy < 10){yy = "0"+yy.toString();} // // 小於 10 不到兩位 換成字串前補0

var yyMod = yMod%500             // --> 剩下的部份， 

var y3 = parseInt(yyMod/100) // --> 再除以 100，得百分位分區 x: A~H , 0~7
var y3n = GchkArea100Y[y3]

var y3Mod = yyMod%100 // --> 剩下的部份，
var y2 = parseInt(y3Mod/10)   //--> 再除以 10，得十分位
var y1 = parseInt(y3Mod%10) //--> 最後剩下的部份就是個位數了

var TPname = area+ xx + yy + x3n + y3n + x2 + y2 + x1 + y1 

return TPname
} // func. cal67getTPopwerSub

//-------------------------------------------------------------------------

function getAreaNameByXY(x,y){

inputObj =  getInputObj(GtaipowerSet) // 取查表 物件.

var areaObj = new Object()
areaObj.name = "[x]" 
areaObj.x = 0
areaObj.y = 0

for(var i = 0 ; i < inputObj.length ; i++){

var x0 = parseInt(inputObj[i][1]) ; var y0 = parseInt(inputObj[i][2])
var x1 = x0 + 80000 ; var y1 = y0 + 50000 ;

if( x >= x0 && x < x1 && y >= y0 && y < y1 ){ // 如果x,y皆符合 型態不限
areaObj.name = inputObj[i][0]
areaObj.x = inputObj[i][1]
areaObj.y = inputObj[i][2]} // if 取得符合處的 name x y 存入物件
  
  } // for i inputObj

return areaObj // 傳回物件
} // func. getAreaNameByXY

//-------------------------------------------------------------------------

function getInputObj(arr) // 取得 輸入的查表 矩陣物件化
{ // 共得 i筆，每筆有 j=4 個 的陣列
var str = arr.join("\r\n");
input = str.split("\n") 

for(var i = 0 ; i < input.length ; i++)
{
input[i] = input[i].replace('\t',','); 
input[i] = input[i].replace(/ /g,',');
// 先將 tab、空白 取代為 , // 單一空白則另需 Global search

input[i] = input[i].split(",")} 
// 分割得 二維矩陣
for(var i = 0 ; i < input.length ; i++)
{
 for(var j = 0 ; j < 4 ; j++)
 {
if(input[i][j] == undefined || input[i][j] == "" || input[i][j] == "\r" )            // 如果該欄位 未定義 或空的按enter的, 填 0  一定要 \r 判定 
{input[i][j] = 0} // 強制讀取的設定補0成為完整的矩陣
 
input[i][j] = (input[i][j].toString()).replace('\r','') ; 
// 消掉\n分割過殘存的 \r
 }   // for j
} // for i

return input // ix4 array
} // func. getInputObj

//-------------------------------------------------------------------------
//---tmXY_LLh_7para_func.---

function testData0(){
var objdata = document.set0.inputData
var dataString = []

dataString.push("300660,2766930")
dataString.push("300600,2766900")
dataString.push("300400,2766500")
dataString.push("B")
dataString.push("B6333")
dataString.push("B6333CE")
dataString.push("B6333CE63")
dataString.push("B6333CE6378")

dataString = dataString.join("\r\n")

objdata.value = dataString //for firefox
} // func. testData()

//-------------------------------------------------------------------------

function callQuickSet(set){
  // 強制轉回 asec & ppm
  var arr = [1,2];
  for(var i=0;i<arr.length;i++){
    var a = arr[i];
    var r_unit = document.getElementById("Ru"+a).children[0].value;
    var sf_unit = document.getElementById("sfu"+a).value;
    if(r_unit=="rad") asec_rad("Ru"+a);
    if(sf_unit=="unitless") sf_s("sfu"+a);  
  }
  
var qkset = document.getElementById("quickSetSlt").value

if(set){ qkset = set}

var Datum1 = document.set1.whatDatumSet
var Datum2 = document.set2.whatDatumSet
var TMset1 = document.set1.whatTMset
var TMset2 = document.set2.whatTMset // 取 select 物件

// datum 1="97" 2="67" 3="84" 
//, TM 1="2" 2="3" 3="6" 4="2-119" 5="6-117"  

if(qkset == "set67to84" ){
Datum1.selectedIndex = 2
Datum2.selectedIndex = 3
TMset1.selectedIndex = 1
TMset2.selectedIndex = 3
}

if(qkset == "set67to97" ){
Datum1.selectedIndex = 2
Datum2.selectedIndex = 1
TMset1.selectedIndex = 1
TMset2.selectedIndex = 1
}

if(qkset == "set84to67" ){
Datum1.selectedIndex = 3
Datum2.selectedIndex = 2
TMset1.selectedIndex = 3
TMset2.selectedIndex = 1
}

if(qkset == "set97to67" ){
Datum1.selectedIndex = 1
Datum2.selectedIndex = 2
TMset1.selectedIndex = 1
TMset2.selectedIndex = 1
}

if(qkset == "set67to84PH" ){
Datum1.selectedIndex = 2
Datum2.selectedIndex = 3
TMset1.selectedIndex = 4
TMset2.selectedIndex = 5
}

if(qkset == "set84to67PH" ){
Datum1.selectedIndex = 3
Datum2.selectedIndex = 2
TMset1.selectedIndex = 5
TMset2.selectedIndex = 4
}

if(qkset == "set67to97PH" ){
Datum1.selectedIndex = 2
Datum2.selectedIndex = 1
TMset1.selectedIndex = 4
TMset2.selectedIndex = 4
}

if(qkset == "set97to67PH" ){
Datum1.selectedIndex = 1
Datum2.selectedIndex = 2
TMset1.selectedIndex = 4
TMset2.selectedIndex = 4
}

if(qkset == "none" ){
Datum1.selectedIndex = 0
Datum2.selectedIndex = 0
TMset1.selectedIndex = 0
TMset2.selectedIndex = 0
}

getSltDatumData(1);
getSltTMdata(1);
getSltDatumData(2);
getSltTMdata(2);
} // func. callQuickSet

//-------------------------------------------------------------------------

function getSltDatumData(num){ // HTML
  // 強制轉回 asec & ppm
  var r_unit = document.getElementById("Ru"+num).children[0].value;
  var sf_unit = document.getElementById("sfu"+num).value;
  if(r_unit=="rad") asec_rad("Ru"+num);
  if(sf_unit=="unitless") sf_s("sfu"+num);

  // 取得選取的Datum設定填到表單內 
  var whatDatumSetStr = document.forms[num].whatDatumSet.value; //string
  var paras = whatDatumSetStr.split(",");
  // 取表單 填值  
  var datumSetDatas = document.forms[num].DatumSetData
  for(var  i=0 ; i < datumSetDatas.length ; i++)
  {datumSetDatas[i].value = paras[i]; }
  // 取 input datumSetData , 把 whatDatumSet 值集合0~10依序填入 
} // func.getSltDatumData()

//-------------------------------------------------------------------------
  
function getSltTMdata(num){ // HTML
  // 取得選取的TM設定填到表單內
    var whatTMsetStr = document.forms[num].whatTMset.value; 
    var paras = whatTMsetStr.split(",") 
    // 取select whatTMset.value 分割值成各項值集合陣列    
    var tmSetDatas = document.forms[num].tmSetData 
    for(var i = 0 ; i < tmSetDatas.length ; i++) // i = 0~5 
    {tmSetDatas[i].value = paras[i];} 
    //取input tmSetData 同名集合 , 依序給值，input 物件值就會更新顯示
} // func. getSltTMdata()

//-------------------------------------------------------------------------

function saveDatumDataSub(set){
// set = 1 or 2 
var DatumSetting = [];

var obj_DatumSetData = document.forms[set].DatumSetData

  for( var i = 0 ; i < obj_DatumSetData.length ; i++ )
  {DatumSetting.push(obj_DatumSetData[i].value) ; }

return DatumSetting
}

//-------------------------------------------------------------------------

function saveTMdataSub(set){

var TMsetting = [];

var obj_tmSetData = document.forms[set].tmSetData 
    for( var i = 0 ; i < obj_tmSetData.length ; i++ ) // i = 0~5 
    { TMsetting.push(obj_tmSetData[i].value); } 

return TMsetting
}

//-------------------------------------------------------------------------

function loadDatumData(datumSet,set){ // HTML

var datumSetDatas = document.forms[set].DatumSetData

  for( var i = 0 ; i < datumSetDatas.length ; i++ )
  {datumSetDatas[i].value = datumSet[i]; }
}

//-------------------------------------------------------------------------

function loadTMdata(arr,set){ // HTML

var tmSetDatas = document.forms[set].tmSetData 

    for( var i = 0 ; i < tmSetDatas.length ; i++ ) // i = 0~5 
    { tmSetDatas[i].value = arr[i]; } 
}

//-------------------------------------------------------------------------

function llGMap(n){
  // global
  var map = mapG, data = GoutputData;
  
  var bounds = new google.maps.LatLngBounds();

  if(!data.length) return;

data.map(d=>{
    let LatY = d['LLh'+n].LatY;
    let LngX = d['LLh'+n].LngX;
    let LLh = round(LatY,'ll') +","+ round(LngX,'ll');
    let html = LLh + "<br/>" + d.cmt;
    let point = new google.maps.LatLng(LatY,LngX);
    bounds.extend(point);
    createMarker(map,point,html,"","",IconStyle1);
  });

map.fitBounds(bounds);

}

function outputData2GMap()
{
alert("Add PlaceMark!");

var MapG = mapG ; var goutputData = GoutputData
var num = goutputData.length // 共有幾筆

var bounds = new google.maps.LatLngBounds()

for(var i = 0 ; i < num ; i++ ){ 

var LatY = goutputData[i].LLh2.LatY
var LngX = goutputData[i].LLh2.LngX
var LLh2 = round(LatY,'ll') +","+ round(LngX,'ll')
var comment = LLh2 + "<br/>" + goutputData[i].cmt

var point = new google.maps.LatLng(LatY,LngX);
bounds.extend(point)

 createMarker(MapG,point,comment,LLh2,"",IconStyle1)
 } // for i

MapG.fitBounds(bounds)
 
} // func. outputData2GMap

//-------------------------------------------------------------------------

function getAllset() // disabled
{
var obj_viewDatumData = new Array(3);
for( i = 0 ; i < 3 ; i++ )
{obj_viewDatumData[i] = new Array(11); }
// 二維陣列 0~2 = set0~2 , 0~10=DatumSetData0~10 共 11 項 

for( i=1 ; i<=2 ; i++){
for( j=0 ; j < document.forms[i].DatumSetData.length ; j++)
{obj_viewDatumData[i][j] = document.forms[i].DatumSetData[j].value;}
}
// 新建的二維陣列取得了兩個表單的 DatumSetData 1,2

var obj_viewTMData = new Array(3);
for(i = 0 ; i < 3 ; i++)
{obj_viewTMData[i] = new Array(6)} 
// 二維陣列, 0~2 表示 set0~2 , 0~5 表示 TM五項set.

for( i = 1 ; i<= 2 ; i++){ // 取 set 1,2
for( j = 0 ; j < document.forms[i].tmSetData.length ; j++) // input 0~5
{obj_viewTMData[i][j] = document.forms[i].tmSetData[j].value;}
}

alert("all:\n" + obj_viewDatumData[1] + "\n" + obj_viewTMData[1] + "\n" 
      + obj_viewDatumData[2] + "\n" + obj_viewTMData[2]);

// 取 set0 textarea , 給值
var obj_settingView = document.set0.settingView
var tmpstr = 
obj_viewDatumData[1] + "\n" + obj_viewTMData[1] +
"\n" + obj_viewDatumData[2] + "\n" + obj_viewTMData[2]

//obj_settingView.innerText = tmpstr
obj_settingView.value = tmpstr
// for firefox

} // func. getAllset()

//-------------------------------------------------------------------------

function chkInputDatumData(set){

var obj_a = document.getElementById("sma."+set)
var obj_divf = document.getElementById("divf."+set)
var obj_b = document.getElementById("smb."+set)
// 取物件

var a = obj_a.value
var divf = obj_divf.value
var b = obj_b.value
// 取值

a = parseFloat(a)

if( divf == "1/f"){divf = NaN;}

divf = parseFloat(divf)
b = parseFloat(b)
alert(a+","+typeof(a)+"\n" +divf +","+ typeof(divf)+"\n"+b+","+typeof(b) )
// 轉成 浮點數,其中 1/f 轉浮點會得到 1 , 先檢查為字串然後擋掉

// 判別1: 檢查 a , b ,1/f 有無
if( isNaN(a) & isNaN(b) & isNaN(divf) )
{alert("a ,b,1/f 沒有有效的值");}

else if( !isNaN(b) & !isNaN(divf) & isNaN(a) )  
{alert("有 b 有 1/f , 計算 a"); 
a = b /(1 - 1/divf ) ; obj_a.value = a;
check_2(a,b,divf);}

else if( !isNaN(a) & isNaN(divf) & !isNaN(b) )
{alert("有 a 有 b , 計算 1/f");
divf = 1/((a - b)/a) ; obj_divf.value = divf ; 
check_2(a,b,divf);}

else if(!isNaN(a) & !isNaN(divf) & isNaN(b) )
{alert("有 a 有 1/f , 計算 b"); 
b = a*(1 - 1/divf ); obj_b.value = b;
check_2(a,b,divf);}

else if(!isNaN(a) & !isNaN(divf) & !isNaN(b))
{alert("三者皆有! pass!"); 
check_2(a,b,divf)}

else
{alert("數據不足, 至少要有 a,b OR b,1/f 或 a,1/f ");}

// 判別2: 檢查值範圍是否有效
function check_2(a,b,divf)
{
if ( !isNaN(a) & !isNaN(divf) )
{alert("有 a , 有 1/f 即可");

if (a > 6377200 & a < 6378600)
{alert("a是目前已知有效的長軸");}

else if(a < 6377200 | a > 6378600)
alert(" a 比目前所有已知的 a 過大或過小"); 

else if( a < b)
alert("a比b還小！");

}
else
{alert("數據不足")}
} // func. check_2

alert (a+","+b+","+divf)

} // chkInputDatumData(set)

//-------------------------------------------------------------------------
function addDatumOption(pos){

var DatumValue = new Array(document.forms[pos].DatumSetData.length);
for(var i =0 ; i < DatumValue.length ; i++)
{DatumValue[i] = document.forms[pos].DatumSetData[i].value}
// 取得 DatumSetData項目數量 ; 建立跟 DatumSetData 一樣的物件 
//抓取目前 input DatumSetData 的值

alert(DatumValue) // 顯示所抓的值集合

var objDatumSelect = document.forms[pos].whatDatumSet
//取下 datum選單
objDatumSelect.options[objDatumSelect.options.length] = new Option(DatumValue[0],DatumValue)
// 加入新的選項
} // addDatumOption(pos)

//-------------------------------------------------------------------------

function addTMOption(pos){

var tmValue = new Array(document.forms[pos].tmSetData.length);
for(var i=0 ; i < tmValue.length ; i++)
{tmValue[i] = document.forms[pos].tmSetData[i].value}
//抓取目前 input tmSetData 的值

alert(tmValue)

var objtmSelect = document.forms[pos].whatTMset
// 取下 tm選單
objtmSelect.options[objtmSelect.options.length] = new Option(tmValue[0],tmValue)
// 加入新選項
} // addTMOption(pos)

//-------------------------------------------------------------------------

function getInputDataStr(){
var obj_inputDataString = document.set0.inputData.value
// 標準 = .innerText ? // 從 textarea 取值
return obj_inputDataString
}

//-------------------------------------------------------------------------
function getInputDataSub(obj_inputDataString){
// 取值 處理 傳回處理好的資料矩陣

var objData = obj_inputDataString.split("\n")
// 不論 ie 或 firefox 一定都會有 \n 可分割
// for firefox 只以 \n 分割 因為似乎只有 \n 存在

for(var i=0,num=objData.length ; i < num ; i++)
{objData[i] = objData[i].replace('\t',','); 
//objData[i] = objData[i].replace(/ /g,',');
// 先將 tab、空白 取代為 , ; 單一空白則另需 Global search
objData[i] = objData[i].split(","); }
// 每筆資料再逗號分隔為陣列，成為二維矩陣

var LngX = 0.0 ;
var LatY = 0.0 ;
var h = 0.0 ;
var cmt ="comment" ;
var chk = "unknown" ;

// 順過一遍資料,但每筆資料都只訪問欄位 0,1,2,3 (前4筆)
for(var i=0,num=objData.length ; i < num ; i++){// outer

for(var j = 0 ; j < 4 ; j++){ // inner 0x 1y 2h 3cmt

if(objData[i][j] == undefined || objData[i][j] == "" || objData[i][j] == "\r" )            // 如果該欄位 未定義 或空的按enter的, 填 0  一定要 \r 判定 
if(j != 3)       // 如果不是第3筆,填0 , 第3筆填字串 "cmt"
{objData[i][j] = 0} 
else{objData[i][j] = "cmt"}

objData[i][j] = (objData[i][j].toString()).replace('\r','')
// 轉成字串 , 前面 \n LF 做分割判定了, 殺掉可能剩下的 \r CR enter 符號

} // for inner 
//一筆資料補完0 之後，檢查為何種資料

LatY = objData[i][0] ; LngX = objData[i][1] ; h = objData[i][2];
cmt = objData[i][3] ;
chk = objData[i][4] ;

objData[i][4] = dataTypeChkSub(LatY,LngX,h,cmt,chk,objData[i])
// 檢查資料，決定型態

} // for outer

//if(tmp == obj_inputDataString){alert("ok: "+tmp.length)}
//else
//{alert(obj_inputDataString.length);alert(tmp.length)}
// 判別輸入前後的資料長度 目前似乎只有 ie 會相同 ok
// firefox = chrome 都不會相等, 差在 CR LF 

return objData ;  // i , j
} //func. getInputDataSub()

//-------------------------------------------------------------------------

function dataTypeChkSub(LatY,LngX,h,cmt,chk,data){

var result = "unknown"

var chkLLhSub = function(LngX,LatY){
  if(LngX >= -180 && LngX <= 180 && LatY >= -90 && LatY <= 90) result = "LLh" ; 
};

if(!isNaN(LatY) && !isNaN(LngX) ){ // 如果前兩位是數字
if(isNaN(h)){ data[3] = data[2] + ";" + data[3] ; data[2] = 0 ; }
// 如果 h 不是數字，就合併到 cmt 去 ，h再為0
result = "xy"  // 先視為 xy。
chkLLhSub(LngX,LatY); // 在 x=-90~90 y=-180~180 之間, 判定為 LLh
} // 如果前兩位是數字.

if(isNaN(LatY) ){ // 如果第一個資料不是數字
result = "Address" ; // 預設為地址
LngX = LngX.toString().toUpperCase() // 第二個資料判別強制字元
if(LngX == "ADDRESS" ){ result = "Address" ; }
if(LngX == "TPN"){result = "TPn" ; }

if(LatY.length <= 11 ){     // 如果在11個字以內

 var str = LatY ; var num = LatY.length ; // 進行電力座標判別
 var area = GAreaNames ; // 取所有電力座標區域

var chkTPnAsub = function(str,area,result){

 for(var i = 0 ; i < area.length ; i++)
 {if( str.charAt(0).toUpperCase() == area[i]){ result = "TPnA" ; break; } }
return result
}; // func. chkTPnASub

var chkTPn2345sub= function(str,result){ 
 if( result == "TPnA" ){ 
   for(var i = 1 ; i <= 4 ; i++){
   if( isNaN(parseInt(str.charAt(i))) )
   {result = "unknown" ; break ; }else{ result = "TPn5" } } } 
return result
}; // func. chkTPn2345Sub


var chkTPn67sub = function(str,result){
 var a1 = str.charAt(5).toUpperCase() , a2 = str.charAt(6).toUpperCase() ;   
 if( result == "TPn5" ){ 
    for(var i = 0 ; i < GchkArea100X.length ; i++){
    if( a1 == GchkArea100X[i] ){result = "TPn6"; break; } } }    
 if( result == "TPn6" ){ 
    for(var i = 0 ; i < GchkArea100Y.length ; i++){
    if( a2 == GchkArea100Y[i] ){result = "TPn7"; break; } } } 
return result           
}; // func. chkTPn67Sub

var chkTPn89sub = function(str,result){
 if( result == "TPn7" ){ // 7,8
   for(var i = 7 ; i <= 8 ; i++){
   if( isNaN(parseInt(str.charAt(i))) )
   {result = "unknown" ; break ; }else{ result = "TPn9" } } } 
return result
}; // func. chkTPn89Sub

var chkTPn1011sub = function(str,result){
 if( result == "TPn9" ){ // 9,10
   for(var i = 9 ; i <= 10 ; i++){
   if( isNaN(parseInt(str.charAt(i))) )
   {result = "unknown" ; break ; }else{ result = "TPn11" } } } 
return result
}; // func. chkTPn1011Sub

 if( num == 1 ){ result = chkTPnAsub(str,area,result); }
                 // if 1
 
 if( num == 5 ){ 
 result = chkTPnAsub(str,area,result); 
 result = chkTPn2345sub(str,result);
               } // if 5

 if( num == 6 || num == 7 ){
 result = chkTPnAsub(str,area,result);
 result = chkTPn2345sub(str,result);
 result = chkTPn67sub(str,result); 
               } // if 7
 
 if( num == 8 || num == 9 ){
 result = chkTPnAsub(str,area,result);
 result = chkTPn2345sub(str,result); 
 result = chkTPn67sub(str,result); 
 result = chkTPn89sub(str,result); 
               } // if 9

 if( num == 11 ){
 result = chkTPnAsub(str,area,result); 
 result = chkTPn2345sub(str,result); 
 result = chkTPn67sub(str,result); 
 result = chkTPn89sub(str,result); 
 result = chkTPn1011sub(str,result);
                } // if 11

              } // if total 11

} // 如果第一個資料不是數字

//if( isNaN(LngX) || isNaN(LatY) || isNaN(h) )
//{// 0 or 1 or 2 有不是數字的資料
//objData[i][4] = "false"; }

if(chk != undefined ){ // 如果不是 undefined 才可以字串處理

chk = chk.toString().replace('\r',''); // 刪尾處 CR
chk = chk.toUpperCase(); // 轉大寫

if( chk == "XY") // 使用者自行輸入了欄位 4=chk 
{result = "xy";} // 欄位4或為前項判別更改，再更改回來

if( chk == "LLH") chkLLhSub(LngX,LatY); // 使用者強制定義為經緯，再次檢查

if( chk == "ADDRESS")
{result = "Address";}

if( chk == "TPN")
{result = "TPn";}
   
   } // if chk 

return result
} // func. dataTypeChkSub

//-------------------------------------------------------------------------

function getInputDataAll(){
var inputDataStr = getInputDataStr()    // 取得輸入區字串
var inputData = getInputDataSub(inputDataStr) // 識別型態並轉成矩陣物件
UpdateSettingViewSub(inputData) //矩陣物件輸出到觀看區
} //  func. getInputDataAll()

//-------------------------------------------------------------------------

function UpdateSettingViewSub(inputData)
{ // 將讀取好的輸入資料矩陣，製作成輸出顯示格式 + , + CR+LF
inputData = inputData.join("\r\n");
// 利用 array.join 的功能 將每筆資料合成 \r\n 分隔的字串集合 定址到 tmp

var obj_outputData = document.set0.settingView
//obj_outputData.innerText = tmp
//for firefox
obj_outputData.value = inputData

} // func. UpdateSettingView(inputData)

//-------------------------------------------------------------------------

function calcInputDataAll() // 依表單參數計算
{
var inputDataStr = getInputDataStr() 
var inputData = getInputDataSub(inputDataStr) 
var outputData = calcInputData7paraSub(inputData)
outputDataPRN(outputData)

GoutputData = outputData; // 輸出資料丟一份到 Global var. 
// OK 的. 不需取了再用. 效能幾乎無差

} // func. calcInputDataAll

//-------------------------------------------------------------------------

function outputDataPRN(outputData) 
{ // 檢查選取項目; 選擇性輸出;

var tmp0 = [] ; var tmp = [] ; // 設定暫存二維文字矩陣

var chkLLh1 = document.getElementById("LLh1")
var chktmXY1 = document.getElementById("tmXY1")
var chkXYZ1 = document.getElementById("XYZ1") 
var chkXYZ0 = document.getElementById("XYZ0") 
var chkXYZ2 = document.getElementById("XYZ2") 
var chkLLh2 = document.getElementById("LLh2") 
var chktmXY2 = document.getElementById("tmXY2")

var chkTPname1 = document.getElementById("TPName1")
var chkTPname2 = document.getElementById("TPName2")

var AddressCHK = document.getElementById("AddressCHK")
var Address1 = document.getElementById("Address1")
var Address2 = document.getElementById("Address2")

//取得選取項目物件矩陣

// 第0筆資料, 用來判別選取了哪些項目
tmp0.push(0)
if(chkLLh1.checked )
{tmp0.push("LLh1.LatY","LLh1.LngX","LLh1.h"); } // LLh1

if(chktmXY1.checked )
{tmp0.push("tmXY1.X","tmXY1.Y","tmXY1.h"); }    // TMxy1

if(chkLLh2.checked )
{tmp0.push("LLh2.LatY","LLh2.LngX","LLh2.h"); } // LLh2

if(chktmXY2.checked )
{tmp0.push("tmXY2.X","tmXY2.Y","tmXY2.h"); }   // TMxy2

if(chkXYZ1.checked )
{tmp0.push("XYZ1.X","XYZ1.Y","XYZ1.Z"); }   // XYZ1

if(chkXYZ0.checked )
{tmp0.push("XYZ0.X","XYZ0.Y","XYZ0.Z"); }  // XYZ0

if(chkXYZ2.checked )
{tmp0.push("XYZ2.X","XYZ2.Y","XYZ2.Z"); }  // XYZ2

if(chkTPname1.checked)
{tmp0.push("TPName1"); }   // TPName1

if(chkTPname2.checked)
{tmp0.push("TPName2"); }  // TPName2

{tmp0.push("comment")}    // comment

if(AddressCHK.checked){
if(Address1.checked){tmp0.push("Address1"); } // if 1
if(Address2.checked){tmp0.push("Address2"); } // if 2
} // if
// 

for(var i = 0 ; i < outputData.length ; i++) // 開始處理所有資料
{ tmp[i] = [];

tmp[i].push(i+1) ; // 第一個加入的是"資料編號"

if(chkLLh1.checked )
{tmp[i].push(round(outputData[i].LLh1.LatY,'ll'),
             round(outputData[i].LLh1.LngX,'ll'),
             round(outputData[i].LLh1.h,'xy') ); } // LLh1

if(chktmXY1.checked )
{tmp[i].push(round(outputData[i].tmXY1.X,'xy'),
             round(outputData[i].tmXY1.Y,'xy'),
             round(outputData[i].tmXY1.h,'xy') ); } // TMxy1

if(chkLLh2.checked )
{tmp[i].push(round(outputData[i].LLh2.LatY,'ll'),
             round(outputData[i].LLh2.LngX,'ll'),
             round(outputData[i].LLh2.h,'xy') ); } // LLh2

if(chktmXY2.checked )
{tmp[i].push(round(outputData[i].tmXY2.X,'xy'),
             round(outputData[i].tmXY2.Y,'xy'),
             round(outputData[i].tmXY2.h,'xy') ); } // TMxy2

if(chkXYZ1.checked ) 
{tmp[i].push(round(outputData[i].XYZ1.X,'xy'),
  round(outputData[i].XYZ1.Y,'xy'),
  round(outputData[i].XYZ1.Z,'xy')); } // XYZ1

if(chkXYZ0.checked ) 
{tmp[i].push(round(outputData[i].XYZ0.X,'xy'),
  round(outputData[i].XYZ0.Y,'xy'), 
  round(outputData[i].XYZ0.Z,'xy')); } // XYZ0

if(chkXYZ2.checked ) 
{tmp[i].push(round(outputData[i].XYZ2.X,'xy'),
  round(outputData[i].XYZ2.Y,'xy'),
  round(outputData[i].XYZ2.Z,'xy')); } // XYZ2

if(chkTPname1.checked)
{var x1 = round(outputData[i].tmXY1.X,'xy');
 var y1 = round(outputData[i].tmXY1.Y,'xy');
 var tpname1 = calc67getTPowerSub(x1,y1);
tmp[i].push(tpname1); }                        // TPName1

if(chkTPname2.checked)
{var x2 = round(outputData[i].tmXY2.X,'xy');
 var y2 = round(outputData[i].tmXY2.Y,'xy');
 var tpname2 = calc67getTPowerSub(x2,y2);
tmp[i].push(tpname2); }                       // TPName2

tmp[i].push(outputData[i].cmt);   // comment
} // for i

var obj_outputData = document.set0.settingView
//obj_outputData.innerText = tmp
//for firefox

// 如果要轉出地址，開始特殊處理
if( AddressCHK.checked )
{
var i = 0 ; obj_outputData.value = tmp0 + "\r\n" ;
var geocoder = new google.maps.Geocoder();

if(Address1.checked){ 
// working       
geocodeRun = window.setInterval(function(){

var lat1 = round(outputData[i].LLh1.LatY,'ll')
var lng1 = round(outputData[i].LLh1.LngX,'ll')
var latlng1 = new google.maps.LatLng(lat1,lng1)

    geocoder.geocode({'latLng': latlng1},function(results, status)
    { geocodeFuncSub(results, status, tmp,i,obj_outputData); 
      i = i + 1 ; }//callback func.      
                    ); // geocoder

if(AddressCHK.checked == false )
{window.clearInterval(geocodeRun); alert("Canceled"); }
} ,1500); // var geocodeRun setInterval

} // if 1

if(Address2.checked){
// working
geocodeRun = window.setInterval(function(){

var lat2 = round(outputData[i].LLh2.LatY,'ll')
var lng2 = round(outputData[i].LLh2.LngX,'ll')
var latlng2 = new google.maps.LatLng(lat2,lng2)

    geocoder.geocode({'latLng': latlng2},function(results, status)
    { geocodeFuncSub(results, status, tmp,i,obj_outputData);
      i = i + 1 ; }// callback func.      
                    ); // geocoder

if(AddressCHK.checked == false )
{window.clearInterval(geocodeRun); alert("Canceled"); }
} ,1500); // var geocodeRun setInterval

} // if 2

// working    
function geocodeFuncSub(results, status, tmp,i,obj_outputData){

 var response ;
     if (status == google.maps.GeocoderStatus.OK) {
        if (results[0]) { 
        response = results 
          } else {alert("No results found"); }
     }else{ alert("Geocoder failed : " + status); }
         
     if(response){
     var GCaddress = response[0].formatted_address ; // 0層最詳細
     }
     else{ var GCaddress = "[geocode error]" }
     
     tmp[i].push(GCaddress)
     obj_outputData.value += tmp[i]+ "\r\n" ; 
     
     if( i == tmp.length -1 ) // 最後一個.
{window.clearInterval(geocodeRun); alert("Completed"); }

} // func. geocodeFuncSub
    
}// if chkaddress
else{
obj_outputData.value = tmp0 + "\r\n" ;
obj_outputData.value += tmp.join("\r\n") ;
// alert("Completed");
 }
  // 輸出到結果窗格


} // func. outputDataPRN()

//-------------------------------------------------------------------------
function convAddressAlert(){
var AddressCHK = document.getElementById("AddressCHK")
if(AddressCHK.checked)
{alert("地址轉換目前為 1.5 秒轉換一次, 請考量伺服器負荷避免過量! "); }
} // func. 


//-------------------------------------------------------------------------

function calcInputData7paraSub(inputData,d1,d2,t1,t2)
{ // get,chk,obj  ; 7para 0=lat,x 1=lng,y 2=h 3=cmt 4=chk 
var num = inputData.length       // 獲得筆數

var objLLh1 = new Array()
var objTMxy1 = new Array()
var objXYZ1 = new Array()
var objXYZ0 = new Array()
var objXYZ2 = new Array()
var objLLh2 = new Array()
var objTMxy2 = new Array() // 不只一筆資料

var outputData = new Array() // 建立輸出資料矩陣型態

for(var i = 0 ; i < num ; i++){ // 處理多筆資料開始

objLLh1[i] = new Object() 
objLLh1[i].LatY = 0.0
objLLh1[i].LngX = 0.0
objLLh1[i].h = 0.0  

objTMxy1[i] = new Object()
objTMxy1[i].X = 0.0
objTMxy1[i].Y = 0.0
objTMxy1[i].h = 0.0 // 先準備好便當

if(inputData[i][4] == "LLh" )
{ 
  objLLh1[i].LatY = parseFloat(inputData[i][0]);
  objLLh1[i].LngX = parseFloat(inputData[i][1]);
  objLLh1[i].h = parseFloat(inputData[i][2]);
  objLLh1[i].set = 1;

  objTMxy1[i] = LLh2tmXY(objLLh1[i].LatY, objLLh1[i].LngX, objLLh1[i].h ,1,d1,t1);
  // 先將輸入資料建立成物件 LLh1 另將經緯壓平得 tmXY1
}
else if(inputData[i][4] == "xy" )
{ 
  objTMxy1[i].X = parseFloat(inputData[i][0]); 
  objTMxy1[i].Y = parseFloat(inputData[i][1]);
  objTMxy1[i].h = parseFloat(inputData[i][2]); 
  objTMxy1[i].set = 1; 
  // 如果已是 tmXY1 , 建立 tmXY1 物件，再產生 LLh1
  objLLh1[i] = tmXY2LLh(objTMxy1[i].X, objTMxy1[i].Y, objTMxy1[i].h, 1,d1,t1);
}
else if(inputData[i][4] == "TPnA" )
{
  var a = inputData[i][0];
  var r = getXY_TPnA(a);
  objTMxy1[i].X = parseFloat(r['x']); 
  objTMxy1[i].Y = parseFloat(r['y']);
  objTMxy1[i].h = parseFloat(inputData[i][2]); 
  objTMxy1[i].set = 1; 
  objLLh1[i] = tmXY2LLh(objTMxy1[i].X, objTMxy1[i].Y, objTMxy1[i].h, 1,d1,t1);
}
else if(inputData[i][4] == "TPn5" )
{
  var a = inputData[i][0];
  var r = getXY_TPn5(a);
  objTMxy1[i].X = parseFloat(r['x']); 
  objTMxy1[i].Y = parseFloat(r['y']);
  objTMxy1[i].h = parseFloat(inputData[i][2]); 
  objTMxy1[i].set = 1; 
  objLLh1[i] = tmXY2LLh(objTMxy1[i].X, objTMxy1[i].Y, objTMxy1[i].h, 1,d1,t1);
}
else if(inputData[i][4] == "TPn7" )
{
  var a = inputData[i][0];
  var r = getXY_TPn7(a);
  objTMxy1[i].X = parseFloat(r['x']); 
  objTMxy1[i].Y = parseFloat(r['y']);
  objTMxy1[i].h = parseFloat(inputData[i][2]); 
  objTMxy1[i].set = 1; 
  objLLh1[i] = tmXY2LLh(objTMxy1[i].X, objTMxy1[i].Y, objTMxy1[i].h, 1,d1,t1);
}
else if(inputData[i][4] == "TPn9" )
{
  var a = inputData[i][0];
  var r = getXY_TPn9(a);
  objTMxy1[i].X = parseFloat(r['x']); 
  objTMxy1[i].Y = parseFloat(r['y']);
  objTMxy1[i].h = parseFloat(inputData[i][2]); 
  objTMxy1[i].set = 1; 
  objLLh1[i] = tmXY2LLh(objTMxy1[i].X, objTMxy1[i].Y, objTMxy1[i].h, 1,d1,t1);
}
else if(inputData[i][4] == "TPn11" )
{
  var a = inputData[i][0];
  var r = getXY_TPn11(a);
  objTMxy1[i].X = parseFloat(r['x']); 
  objTMxy1[i].Y = parseFloat(r['y']);
  objTMxy1[i].h = parseFloat(inputData[i][2]); 
  objTMxy1[i].set = 1; 
  objLLh1[i] = tmXY2LLh(objTMxy1[i].X, objTMxy1[i].Y, objTMxy1[i].h, 1,d1,t1);
}
// end if
  // 故一律都是 tmXY 2 LLh 2 XYZ1 XYZ0 XYZ2 LLh2 tmXY2
  objXYZ1[i] = LLh2XYZ(objLLh1[i].LatY, objLLh1[i].LngX, objLLh1[i].h, 1,d1);
  objXYZ0[i] = XYZ2XYZ(objXYZ1[i].X, objXYZ1[i].Y, objXYZ1[i].Z, 1,d1);
  objXYZ2[i] = XYZ2XYZ(objXYZ0[i].X, objXYZ0[i].Y, objXYZ0[i].Z, 2,d2); 
  objLLh2[i] = XYZ2LLh(objXYZ2[i].X, objXYZ2[i].Y, objXYZ2[i].Z, 2,d2);
  objTMxy2[i] = LLh2tmXY(objLLh2[i].LatY, objLLh2[i].LngX, objLLh2[i].h, 2,d2,t2); 
// func. return 之後可以不必再宣告位址存放

outputData[i] = new Object()
outputData[i].tmXY1 = objTMxy1[i] 
outputData[i].LLh1 = objLLh1[i]
outputData[i].XYZ1 = objXYZ1[i]
outputData[i].XYZ0 = objXYZ0[i]
outputData[i].XYZ2 = objXYZ2[i]
outputData[i].LLh2 = objLLh2[i]
outputData[i].tmXY2 = objTMxy2[i]
outputData[i].cmt = inputData[i][3]
                              
 } // for i

return outputData; // i
} // func. calcInputData7paraSub()

//-------------------------------------------------------------------------

function tmXY2LLh(tmX,tmY,h,set,datum,tm){ //計算時不應取頁面參數
var a = parseFloat(document.getElementById("sma."+set).value)  
var divf = parseFloat(document.getElementById("divf."+set).value)

var Lng0 = parseFloat(document.getElementById("Lng0."+set).value)
var Lat0 = parseFloat(document.getElementById("Lat0."+set).value)
var k0 = parseFloat(document.getElementById("k0."+set).value)
var FE = parseFloat(document.getElementById("FE."+set).value)
var FN = parseFloat(document.getElementById("FN."+set).value); // 取 TM 參數

// setting override:
if(datum){
  a = DATUM[datum][0];
  divf = DATUM[datum][1];
}
if(tm){
  Lng0 = TM[tm][0];
  Lat0 = TM[tm][1];
  k0 = TM[tm][2];
  FE = TM[tm][3];
  FN = TM[tm][4];
}

var f = 1 / divf
var e2 = 2*f - f*f
var e_2 = f*(2-f) / POW((1-f),2) 
var e4 = POW(e2,2) ; var e6 = POW(e2,3)
var e1 = (1 - SQRT(1 - e2) ) / (1 + SQRT(1 - e2) )  

var J1 = (3*(e1)/2 - 27*( POW(e1,3) )/32)
var J2 = (21*(POW(e1,2))/16 - 55*(POW(e1,4))/32)
var J3 = (151*(POW(e1,3))/96)
var J4 = (1097*(POW(e1,4))/512) 

var rLng0 = deg2rad(Lng0)
var rLat0 = deg2rad(Lat0)

var M0 = a*( (1 - (e2)/4 - 3*(e4)/64 - 5*(e6)/256 )*rLat0
- (3*(e2)/8 + 3*(e4)/32 + 45*(e6)/1024 )*SIN(2*rLat0) 
+ (15*(e4)/256 + 45*(e6)/1024 )*SIN(4*rLat0)
- (35*(e6)/3072 )*SIN(6*rLat0) );

//Calculate the Meridional Arc 
var M1 = M0 + (tmY - FN) / k0
var mu = M1 / ( a*(1 - (e2)/4 - 3*(e4)/64 - 5*(e6)/256 ) )
//Calculate Footprint Latitude
var fp = mu + J1*SIN(2*mu) + J2*SIN(4*mu) + J3*SIN(6*mu) + J4*SIN(8*mu)
var C1 = e_2 * POW(COS(fp),2)
var T1 = POW(TAN(fp),2)
var R1 = a*(1-e2) / POW((1 - e2*POW(SIN(fp),2) ),(3/2))
var N1 = a / SQRT( 1-(e2)*POW(SIN(fp),2) )
var D = (tmX - FE) / (N1*k0)

var Q1 = N1*TAN(fp)/R1
var Q2 = ( POW(D,2) )/2
var Q3 = (5 + 3*T1 + 10*C1 - 4*POW(C1,2) - 9*e_2)*(POW(D,4))/24
var Q4 = (61 + 90*T1 + 298*C1 +45*POW(T1,2) - 252*e_2 - 3*POW(C1,2) )*(POW(D,6))/720
var outrLatY = fp - Q1*(Q2 - Q3 + Q4)

var Q5 = D
var Q6 = (1 + 2*T1 + C1)*(POW(D,3))/6
var Q7 = (5 - 2*C1 + 28*T1 - 3*POW(C1,2) + 8*e_2 + 24*POW(T1,2))*(POW(D,5))/120

var outrLngX =  rLng0 + (Q5 - Q6 + Q7)/COS(fp)

var objLLh = new Object()
objLLh.LatY = rad2deg(outrLatY)
objLLh.LngX = rad2deg(outrLngX)
objLLh.h = h // 沒有作用到

return objLLh
} // func. tmXY2LLh

//-------------------------------------------------------------------------

function LLh2XYZ(LatY,LngX,h,set,datum){ //LLh 2 XYZ
var rLatY = deg2rad(LatY)
var rLngX = deg2rad(LngX) // deg先轉rad

var a = parseFloat(document.getElementById("sma."+set).value)  
var divf = parseFloat(document.getElementById("divf."+set).value)

// setting override:
if(datum){
  a = DATUM[datum][0];
  divf = DATUM[datum][1];
}

var f = 1 / divf
var e2 = 2*f - f*f
var chi = SQRT( 1 - (e2)*(POW(SIN(rLatY),2)) )
var Nu = a / chi
var X1 = (Nu + h)*COS(rLatY)*COS(rLngX)
var Y1 = (Nu + h)*COS(rLatY)*SIN(rLngX)
var Z1 = ( (Nu)*(1 - e2) + h )*SIN(rLatY) // 算得 XYZ

var objXYZ = new Object() // 建立物件
objXYZ.X = X1
objXYZ.Y = Y1
objXYZ.Z = Z1
objXYZ.set = set   // 裝入

return objXYZ  // 傳回 XYZ 物件

} // func. LLh2XY

//-------------------------------------------------------------------------

function XYZ2XYZ(X1,Y1,Z1,set,datum){ // XYZ1 轉 XYZ2
//取參數值 set1 是 1 轉 0  
var dX = parseFloat(document.getElementById("dX."+set).value)
var dY = parseFloat(document.getElementById("dY."+set).value)
var dZ = parseFloat(document.getElementById("dZ."+set).value)
var rx = parseFloat(document.getElementById("Rx."+set).value) // id大小寫注意 
var ry = parseFloat(document.getElementById("Ry."+set).value) //ie不分辨反而不好
var rz = parseFloat(document.getElementById("Rz."+set).value)
var sfppm = parseFloat(document.getElementById("sfppm."+set).value)

// 2021.03.03: rx.y.z & sf detect
var r_unit = document.getElementById("Ru"+set).children[0].value;
var sf_unit = document.getElementById("sfu"+set).value;
if(r_unit=="rad"){ var b = 3600;
  rx=rad2deg(rx)*b;
  ry=rad2deg(ry)*b;
  rz=rad2deg(rz)*b;
}
if(sf_unit=="unitless"){
  var s = sfppm;
  sfppm = sf_ppm(s,"ppm");
}

// setting override:
if(datum){
  dX = DATUM[datum][3];
  dY = DATUM[datum][4];  
  dZ = DATUM[datum][5];  
  rx = DATUM[datum][6];  
  ry = DATUM[datum][7];  
  rz = DATUM[datum][8];   
  sfppm = DATUM[datum][9];
}

 rx = deg2rad(rx/3600) //來源限定是 ArcSec 弧度秒,故先除 3600 換成度
 ry = deg2rad(ry/3600) // 再轉徑度量rad
 rz = deg2rad(rz/3600)

var Mscale = (1 + sfppm * POW(10,-6) ) // ppm 轉 scale

if(set == 2) // 如果輸入的 XYZ 是要用 set2 ,則為 0 轉 2 全參數加負號
{
dX = -1*(dX) ; dY = -1*(dY) ; dZ = -1*(dZ)
rx = -1*(rx) ; ry = -1*(ry) ; rz = -1*(rz)
Mscale = ( 1 + (-1)*sfppm*POW(10,-6) ) // ppm 乘 -1
}

 X2 = (dX) + Mscale * ( (1)*X1    +  (1)*Y1*rz + (-1)*Z1*ry )
 Y2 = (dY) + Mscale * ((-1)*X1*rz +  (1)*Y1 +     (1)*Z1*rx )
 Z2 = (dZ) + Mscale * ( (1)*X1*ry + (-1)*Y1*rx +  (1)*Z1 )
// bursa-wolf 7para ，Coordinate Frame Rotation CFR
// 固定都寫 XYZ1 轉 XYZ2 ，但set=1時為 1 轉 0 ，set=2 時為 0 轉 2 

var objXYZ = new Object() 
objXYZ.X = X2
objXYZ.Y = Y2
objXYZ.Z = Z2
objXYZ.set = set  // 裝入物件 XYZ

return objXYZ  // 傳回

} // func. XYZ2XYZ

//-------------------------------------------------------------------------

function XYZ2LLh(X2,Y2,Z2,set,datum){ // XYZ 轉 LLh
//取值 XYZ 轉 LLh 時通常 set = 2
var a = parseFloat(document.getElementById("sma."+set).value)
var divf = parseFloat(document.getElementById("divf."+set).value)
//var b = document.getElementById("smb."+set).value 
// datum 參數以 a,1/f 為必要, 即使使用者輸入 b 也不採用

// setting override:
if(datum){
  a = DATUM[datum][0];
  divf = DATUM[datum][1];
}

var f = 1 / divf
var b = a*(1-f) // b 改以運算而得

var e2 = 2*f - f*f
var e_2 = f*(2-f) / POW((1-f),2) 

var Lambda = ATAN2(Y2,X2) // js 

var p = SQRT( X2*X2 + Y2*Y2 )

var the = ATAN( (Z2*a)/(p*b) )  

var phi = ATAN( (Z2 + e_2 *b*POW(SIN(the),3)) / (p - e2*a*POW(COS(the),3)) )

var Nu = a / ( SQRT( 1 - e2*POW(SIN(phi),2) ) )

var h = 0.0

if(phi <= PI/4)
{/*alert("phi <= PI/4 : "+phi+","+PI/4);*/
 h = p/COS(phi) - Nu ; }
else if(phi > PI/4) // 高緯度的時候?
{/*alert("phi > PI/4 : "+phi+","+PI/4); */
 h = ( Z2/SIN(phi) ) - Nu*(1 - e2); }

var objLLh = new Object()
objLLh.LatY = rad2deg(phi)
objLLh.LngX = rad2deg(Lambda)
objLLh.h = h
objLLh.set = set

return objLLh // 傳回 LLh 物件
} // func. XYZ2LLh

//-------------------------------------------------------------------------

function LLh2tmXY(LatY,LngX,h,set,datum,tm){
var rLatY = deg2rad(LatY)
var rLngX = deg2rad(LngX)

var a = parseFloat(document.getElementById("sma."+set).value)
var divf = parseFloat(document.getElementById("divf."+set).value) // 取 Datum 參數

var Lng0 = parseFloat(document.getElementById("Lng0."+set).value)
var Lat0 = parseFloat(document.getElementById("Lat0."+set).value)
var k0 = parseFloat(document.getElementById("k0."+set).value)
var FE = parseFloat(document.getElementById("FE."+set).value)
var FN = parseFloat(document.getElementById("FN."+set).value); // 取 TM 參數

// setting override:
if(datum){
  a = DATUM[datum][0];
  divf = DATUM[datum][1];
}
if(tm){
  Lng0 = TM[tm][0];
  Lat0 = TM[tm][1];
  k0 = TM[tm][2];
  FE = TM[tm][3];
  FN = TM[tm][4];
}

var f = 1 / divf
var b = a*(1-f)
var e2 = 2*f - f*f
var e_2 = f*(2-f) / POW((1-f),2) ; var e_4 = POW(e_2,2) 
var e4 = POW(e2,2) ; var e6 = POW(e2,3)

var rLng0 = deg2rad(Lng0)
var rLat0 = deg2rad(Lat0)

var n = (a-b)/(a+b)

var A = a*(1 - n + (5/4)*(n*n - POW(n,3)) + (81/64)*(POW(n,4) - POW(n,5)) )
var B = (3*a*n/2)*(1-n+(7/8)*(n*n-POW(n,3))+(55/64)*(POW(n,4)-POW(n,5)) )
var C = (15*a*n*n /16)*(1 - n + (3/4)*( n*n - POW(n,3)) )
var D = (35*a*POW(n,3) /48)*(1 - n + (11/16)*( n*n - POW(n,3)) )
var E = (315*a*POW(n,4) / 512)*(1-n)
var S = A*rLatY-B*SIN(2*rLatY)+C*SIN(4*rLatY)-D*SIN(6*rLatY)+E*SIN(8*rLatY);

var Nu = a / SQRT( 1-(e2)*POW(SIN(rLatY),2) )
var p = rLngX - rLng0

var S0 = A*rLat0-B*SIN(2*rLat0)+C*SIN(4*rLat0)-D*SIN(6*rLat0)+E*SIN(8*rLat0)

var dS = S - S0

var K1 = dS*k0
var K2 = k0*Nu*SIN(rLatY)*COS(rLatY)/2 // = k0*Nu*SIN(2*rLatY)/4
var K3 = (k0*Nu*SIN(rLatY)*POW(COS(rLatY),3)/24)*
(5-POW(TAN(rLatY),2) + 9*e_2*POW(COS(rLatY),2) + 4*e_4*POW(COS(rLatY),4));

var T = POW(TAN(rLatY),2)
var Ca = e_2*POW(COS(rLatY),2)
var Aa = (p)*COS(rLatY) 

var K3a = k0*Nu*TAN(rLatY)*(61-58*T + T*T +600*Ca - 330*e_2)*POW(Aa,6)/720 ;
 
var outY = (FN) + K1 + K2*p*p + K3*POW(p,4) + K3a

var K4 = k0*Nu*COS(rLatY)
var K5 = (k0*Nu*POW(COS(rLatY),3)/6)*(1-POW(TAN(rLatY),2)+
e_2*POW(COS(rLatY),2));

var K5a = k0*Nu*(5 - 18*T + T*T + 72*Ca - 58*e_2)*( POW(Aa,5) )/120 ;

var tmpX = K4*p + K5*POW(p,3) + K5a

var outX = FE + tmpX

var objtmXY = new Object()
objtmXY.X = outX
objtmXY.Y = outY 
objtmXY.h = h
objtmXY.set = set

return objtmXY
} // func. LLh2tmXY

//-------------------------------------------------------------------------

function calcDataByNCKU(n)
{
inputDataStr = getInputDataStr() // 取輸入區資料字串
inputData = getInputDataSub(inputDataStr) // 識別並形成矩陣物件
outputData = calcDataByNCKU_Sub(inputData,n) // 1 = 67->97
outputDataPRN(outputData)

GoutputData = outputData // 輸出資料丟一份到 Global var. 
} // func. NCKU 67->97

//-------------------------------------------------------------------------

function calcDataByNCKU_Sub(inputData,set){
// set=1=67->97 set=2=97->67
// backupDatumTMsetG() ; // 備份頁面設定

var A= 0.00001549
var B= 0.000006521
var E67, N67, E97, N97; 

var func1 = function(){  // TWD67-TM2-121 -> TWD97-TM2-121
  E67 = outputData[i].tmXY1.X
  N67 = outputData[i].tmXY1.Y // tmXY1 輸入

  E97 = E67 + 807.8 + A * E67 + B * N67
  N97 = N67 - 248.6 + A * N67 + B * E67 // 67->97

  outputData[i].tmXY2.X = E97 
  outputData[i].tmXY2.Y = N97 // 得到 tmXY2, 取代

  objLLh2 = tmXY2LLh(E97, N97, outputData[i].tmXY2.h, 2, d2,t2)
  // NCKU 公式先得到 tmXY2 再轉 LLh2
};

var func2 = function(){ // 97 -> 67
  E97 = outputData[i].tmXY1.X
  N97 = outputData[i].tmXY1.Y // tmXY1 輸入

  E67 = E97 - 807.8 - A * E97 - B * N97
  N67 = N97 + 248.6 - A * N97 - B * E97 

  outputData[i].tmXY2.X = E67 
  outputData[i].tmXY2.Y = N67 // 得到 tmXY2, 取代 

  objLLh2 = tmXY2LLh(E67, N67, outputData[i].tmXY2.h, 2, d2,t2)
};

var objLLh2,llh2_tmxy2;
var d1='', d2='', tm1='', tm2='';
if(set==1) llh2_tmxy2 = func1, d1 = 'TWD67', d2 = 'TWD97', t1='TM2-121', t2='TM2-121';
if(set==2) llh2_tmxy2 = func2, d1 = 'TWD97', d2 = 'TWD67', t1='TM2-121', t2='TM2-121';

var outputData = calcInputData7paraSub(inputData,d1,d2,tm1,tm2)  
// 計算輸入資料，只取 LLh1 tmXY1 ，其他的還是會經過 7para 轉換，多餘計算。

for(var i = 0 ; i < outputData.length ; i++) // 計算所有資料
{
llh2_tmxy2(); 

var objXYZ2 = LLh2XYZ(objLLh2.LatY , objLLh2.LngX , objLLh2.h , 2,d2)
// XYZ2 用得到的 LLh2 重算

// 輸出裝載資料
outputData[i].LLh2.LatY = objLLh2.LatY 
outputData[i].LLh2.LngX = objLLh2.LngX
outputData[i].LLh2.h = objLLh2.h // 蓋掉 7para 轉得的 LLh2

outputData[i].XYZ2.X = objXYZ2.X
outputData[i].XYZ2.Y = objXYZ2.Y
outputData[i].XYZ2.Z = objXYZ2.Z // 蓋掉 7para 轉得的 XYZ2

outputData[i].XYZ0.X = 0
outputData[i].XYZ0.Y = 0
outputData[i].XYZ0.Z = 0 // 蓋掉 7para 轉得的 XYZ0
// 因為到 prn 處會做 toFixed() ，故不能為字串

// outputData 改造完成

} // for i

// restoreDatumTMsetG() ; // 備份的設定重回頁面

return outputData // i
}// func. calcDataByNCKU_Sub(set)

//-------------------------------------------------------------------------

function calcWGS84_67_97Sub(lat,lng){ // 供 GMap傳回座標運算用函式
// WGS84 latlng 判別選用何種 datum tm 設定

// backupDatumTMsetG() ; // 備份 datum tm 設定到 global
var bakTPset = GtaipowerSet

var d1,d2,t1,t2;
if(lng >= 120 && lng < 126 ) d1='WGS84',t1='TM6-123',d2='TWD67',t2='TM2-121';
//{ callQuickSet("set84to67"); } 
// WGS84-TM6-123-to-TWD67-TM2-121

if(lng >= 114 && lng < 120 ) d1='WGS84',t1='TM6-117',d2='TWD67',t2='TM2-119';
//{ callQuickSet("set84to67PH"); }
// WGS84-TM6-117-to-TWD67-TM2-119

var objtmXY1 = LLh2tmXY(lat, lng, 0, 1, d1,t1); // 用 set1 得 tm6=utm
 
var objXYZ1 = LLh2XYZ(lat, lng, 0, 1, d1); //將傳入的 latlng 進入7paraBW 計算
var objXYZ0 = XYZ2XYZ(objXYZ1.X, objXYZ1.Y, objXYZ1.Z, 1, d1);
  
var objXYZ2 = XYZ2XYZ(objXYZ0.X, objXYZ0.Y, objXYZ0.Z, 2, d2); 
var objLLh2 = XYZ2LLh(objXYZ2.X, objXYZ2.Y, objXYZ2.Z, 2, d2);
var objtmXY2 = LLh2tmXY(objLLh2.LatY, objLLh2.LngX, objLLh2.h, 2, d2,t2);  


// 物件裝載
outputObj = new Object()
outputObj.utm = objtmXY1   // 84 UTM
outputObj.LLh2 = objLLh2   // 67 LLh
outputObj.tmXY2 = objtmXY2 // 67tmXY

// 再來將目的 set2 設成 TWD97 TM2  
// var d2_TWD97 = (document.getElementById("TWD97.2").value).split(",")
// loadDatumData(d2_TWD97,2)
d2='TWD97';

if(lat >= 120 && lat < 126 ) t2='TM2-121';
// {
// var TMset2 = (document.getElementById("TM2.2").value).split(",")
// loadTMdata(TMset2,2)
// }


if(lat >= 114 && lat < 120 ) t2='TM2-119';
// {
// var TMset2 = (document.getElementById("TM2.2.119").value).split(",")
// loadDatumData(TMset2,2)
// }


// 再跑一次set2的運算 得97
objXYZ2 = XYZ2XYZ(objXYZ0.X, objXYZ0.Y, objXYZ0.Z, 2, d2); 
objLLh2 = XYZ2LLh(objXYZ2.X, objXYZ2.Y, objXYZ2.Z, 2, d2);
objtmXY2 = LLh2tmXY(objLLh2.LatY, objLLh2.LngX, objLLh2.h, 2, d2,t2);    

outputObj.LLh97 = objLLh2   // 97 LLh
outputObj.tmXY97 = objtmXY2 // 97tmXY

// 還原頁面設定
// restoreDatumTMsetG() ; 

return outputObj
}

//-------------------------------------------------------------------------

function backupDatumTMsetG(){ // deprecated

var gallset = Gallset ; // 取 global obj

gallset.d1 = saveDatumDataSub(1)
gallset.d2 = saveDatumDataSub(2)
gallset.d1slt = document.getElementById("DatumSet1slt").selectedIndex
gallset.d2slt = document.getElementById("DatumSet2slt").selectedIndex


gallset.tm1 = saveTMdataSub(1)
gallset.tm2 = saveTMdataSub(2) // 備份頁面設定
gallset.tm1slt = document.getElementById("TMset1slt").selectedIndex
gallset.tm2slt = document.getElementById("TMset2slt").selectedIndex

} // func. backupDatumTMsetG to Global 

//-------------------------------------------------------------------------

function restoreDatumTMsetG(){ // deprecated

var gallset = Gallset ; 

loadDatumData(gallset.d1 , 1)
loadDatumData(gallset.d2 , 2)
loadTMdata(gallset.tm1 , 1)
loadTMdata(gallset.tm2 , 2)

var d1sltObj = document.getElementById("DatumSet1slt")
var d2sltObj = document.getElementById("DatumSet2slt")
d1sltObj.selectedIndex = gallset.d1slt
d2sltObj.selectedIndex = gallset.d2slt

var tm1sltObj = document.getElementById("TMset1slt")
var tm2sltObj = document.getElementById("TMset2slt")
tm1sltObj.selectedIndex = gallset.tm1slt
tm2sltObj.selectedIndex = gallset.tm2slt

} // func. restoreDatumTMsetG

//-------------------------------------------------------------------------

testData0();
getSltDatumData(1);  
getSltTMdata(1);
getSltDatumData(2);
getSltTMdata(2);

//-------------------------------------------------------------------------

//-->

//]]>
</script>
<script>
  if(window.google && window.google.maps){
      // the map API is already be loaded (from a previous button click, maybe)
      startMap0();
  
  } else if(!document.getElementById('google-map-script')) {
      // the script tag is not present so add it to the DOM
      var scriptTag = document.createElement('script');
      scriptTag .id = 'google-map-script';
      scriptTag .src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyBPWqfY7rCCyz-Xda_npvhfkIdK2vRfeFM&callback=startMap0';
      var head = document.getElementsByTagName('head')[0];
      head.appendChild(scriptTag);
  }
  </script>